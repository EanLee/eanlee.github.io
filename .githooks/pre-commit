#!/bin/bash

# Git Hook: Pre-commit
# åŠŸèƒ½ï¼šåœ¨ commit ä¹‹å‰ï¼Œè‡ªå‹•æ›´æ–°æœ‰ç•°å‹•çš„ .md æª”æ¡ˆçš„ lastmod front matter

# å–å¾—ç•¶å‰æ™‚é–“æˆ³ (ISO 8601 æ ¼å¼ï¼Œå°åŒ—æ™‚å€)
current_timestamp=$(date '+%Y-%m-%dT%H:%M:%S+08:00')

# æª¢æŸ¥æ˜¯å¦æœ‰ .md æª”æ¡ˆè¢«ä¿®æ”¹æˆ–æ–°å¢
modified_md_files=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.md$')

if [ -z "$modified_md_files" ]; then
    echo "âœ… æ²’æœ‰ Markdown æª”æ¡ˆç•°å‹•ï¼Œè·³é lastmod æ›´æ–°"
    exit 0
fi

echo "ğŸ” ç™¼ç¾ Markdown æª”æ¡ˆç•°å‹•ï¼Œé–‹å§‹æ›´æ–° lastmod..."

# è™•ç†æ¯å€‹è¢«ä¿®æ”¹çš„ .md æª”æ¡ˆ
while IFS= read -r file; do
    if [ -f "$file" ]; then
        echo "ğŸ“ è™•ç†æª”æ¡ˆ: $file"
        
        # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰ front matter
        if head -n 1 "$file" | grep -q "^---$"; then
            # ä½¿ç”¨ PowerShell è…³æœ¬ä¾†è™•ç† front matter
            powershell.exe -Command "
                \$content = Get-Content '$file' -Raw -Encoding UTF8
                if (\$content -match '^---\r?\n(.*?)\r?\n---\r?\n(.*)$') {
                    \$frontMatter = \$matches[1]
                    \$body = \$matches[2]
                    
                    # æª¢æŸ¥æ˜¯å¦å·²æœ‰ lastmod
                    if (\$frontMatter -match 'lastmod:\s*.*') {
                        # æ›´æ–°ç¾æœ‰çš„ lastmod
                        \$frontMatter = \$frontMatter -replace 'lastmod:\s*.*', 'lastmod: $current_timestamp'
                        Write-Host '  âœ“ æ›´æ–°ç¾æœ‰çš„ lastmod'
                    } else {
                        # åœ¨ front matter æœ€å¾ŒåŠ å…¥ lastmod
                        \$frontMatter = \$frontMatter + \"`nlastmod: $current_timestamp\"
                        Write-Host '  âœ“ æ–°å¢ lastmod æ¬„ä½'
                    }
                    
                    # é‡æ–°çµ„åˆæª”æ¡ˆå…§å®¹
                    \$newContent = \"---`n\" + \$frontMatter + \"`n---`n\" + \$body
                    
                    # å¯«å›æª”æ¡ˆ
                    Set-Content '$file' -Value \$newContent -Encoding UTF8 -NoNewline
                    
                    Write-Host '  âœ… æª”æ¡ˆå·²æ›´æ–°'
                } else {
                    Write-Host '  âš ï¸  æª”æ¡ˆæ²’æœ‰æœ‰æ•ˆçš„ front matterï¼Œè·³é'
                }
            "
            
            # é‡æ–°åŠ å…¥åˆ° staging area
            git add "$file"
        else
            echo "  âš ï¸  æª”æ¡ˆæ²’æœ‰ front matterï¼Œè·³é: $file"
        fi
    fi
done <<< "$modified_md_files"

echo "âœ… lastmod æ›´æ–°å®Œæˆ"
exit 0
