<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>ASP.NET Core | 封裝 DI 的註冊行為時，同時使用外部參數來建立不同物件 - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="在 ASP.NET Core 中，當封裝依賴注入（DI）的註冊行為時，同時使用外部參數來建立不同的對象，本文介紹了兩種方法：直接使用 IHttpContextAccessor 和封裝 DI 所需的參數。並推薦使用後者，在不公開服務實作的前提下，通過介面獲取外部參數，以提高程式碼的可維護性和彈性。"><meta property="og:title" content="ASP.NET Core | 封裝 DI 的註冊行為時，同時使用外部參數來建立不同物件"><meta property="og:description" content="在 ASP.NET Core 中，當封裝依賴注入（DI）的註冊行為時，同時使用外部參數來建立不同的對象，本文介紹了兩種方法：直接使用 IHttpContextAccessor 和封裝 DI 所需的參數。並推薦使用後者，在不公開服務實作的前提下，通過介面獲取外部參數，以提高程式碼的可維護性和彈性。"><meta property="og:type" content="article"><meta property="og:url" content="https://eandev.com/post/develop/di-encapsulate-service-and-use-external-parameters/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-06-14T04:56:50+00:00"><meta property="article:modified_time" content="2023-06-14T04:56:50+00:00"><meta itemprop=name content="ASP.NET Core | 封裝 DI 的註冊行為時，同時使用外部參數來建立不同物件"><meta itemprop=description content="在 ASP.NET Core 中，當封裝依賴注入（DI）的註冊行為時，同時使用外部參數來建立不同的對象，本文介紹了兩種方法：直接使用 IHttpContextAccessor 和封裝 DI 所需的參數。並推薦使用後者，在不公開服務實作的前提下，通過介面獲取外部參數，以提高程式碼的可維護性和彈性。"><meta itemprop=datePublished content="2023-06-14T04:56:50+00:00"><meta itemprop=dateModified content="2023-06-14T04:56:50+00:00"><meta itemprop=wordCount content="526"><meta itemprop=keywords content="ASP.NET Core,DI,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ASP.NET Core | 封裝 DI 的註冊行為時，同時使用外部參數來建立不同物件"><meta name=twitter:description content="在 ASP.NET Core 中，當封裝依賴注入（DI）的註冊行為時，同時使用外部參數來建立不同的對象，本文介紹了兩種方法：直接使用 IHttpContextAccessor 和封裝 DI 所需的參數。並推薦使用後者，在不公開服務實作的前提下，通過介面獲取外部參數，以提高程式碼的可維護性和彈性。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=/css/style.min.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img alt=logo src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>ASP.NET Core | 封裝 DI 的註冊行為時，同時使用外部參數來建立不同物件</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-06-14T04:56:50Z>2023-06-14</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/ rel=category>軟體開發</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#目的>目的</a></li><li><a href=#實作>實作</a><ul><li><a href=#作法一-直接調用-ihttpcontextaccessor>作法一: 直接調用 IHttpContextAccessor</a></li><li><a href=#作法二-將-di-所需要的參數封裝>作法二: 將 DI 所需要的參數封裝</a></li></ul></li><li><a href=#延伸閱讀>延伸閱讀</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>當發現一個 .NET Core 的類別，其所有方法均需要相同的參數資料，這時，我們就會想到從 DI 下手，在建立物件時，一併把參數傳入。這樣就不需要在調用方式時，還要重複的傳入參數。</p><p>為了隱藏服務的實現細節，將 DI 的服務註冊行為加以封裝，但又需要 WebApi 的 HttpContext 內的參數，建立對應的物件。</p><p>在這篇文章紀錄了直接使用 IHttpContextAccessor 和封裝 DI 所需的參數，兩筆不同的作法。筆者個人推薦後者的作法。</p><blockquote><p>🔖 長話短說 🔖</p><ul><li>若將 DI 的註冊行為封裝，但又需要傳入外部參數時，可使用 <code>interface</code> ，在取得參數資料的同時，隔離實作的細節。</li><li>若 <code>IHttpContextAccessor</code> 未定義是，需要引用 <code>Microsoft.AspNetCore.Http</code> Nuget 套件。</li></ul></blockquote><p>操作環境：</p><ul><li>Windows 11</li><li>.NET Core 7</li></ul><h2 id=目的>目的</h2><p>若我們開發 ASP.NET Core 程式時，在特定的架構(ex. 三層式架構、洋蔥架構、Clean Archecture) 時，會把商業邏輯獨立在另一個 <code>dll</code> 專案內。但在使用 .NET DI 注入服務時，又希望 Service 的實作不公開，在 ASP.NET Core 的專案內無法查看 Service 的實作內容。</p><p>架構如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Solution
</span></span><span style=display:flex><span>├─ WebApi (ASP.NET Core)
</span></span><span style=display:flex><span>└─ BusinessLogic (Library)
</span></span></code></pre></div><p>這時，我們可能會在 <code>BussinessLogic</code> 的專案內，建立一個 DI 使用的 Extnesion</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DiExtension</span>  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> AddServices(<span style=color:#66d9ef>this</span> IServiceCollection services)  
</span></span><span style=display:flex><span>	{  
</span></span><span style=display:flex><span>		services.AddScoped&lt;IUserService, UserService&gt;();  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以便 ASP.NET Core 內的 <code>Program.cs</code> 中，使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// Program.cs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DI Service</span>
</span></span><span style=display:flex><span>builder.Services.AddServices();
</span></span></code></pre></div><p>這時, 因為所有的 User 相關 API 的路徑，都含有 <code>userId</code> 而且 UserService 內所有的方法，都需要傳入 <code>userId</code>，所以希望可以減少手動傳入參數的行為。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// IUserService</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IUserService</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	UserEntity GetUser(<span style=color:#66d9ef>string</span> userId);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> SetUser(<span style=color:#66d9ef>string</span> userId, UserEntity entity);
</span></span><span style=display:flex><span>	etc...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserService</span>: IUserService
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> UserEntity GetUser(<span style=color:#66d9ef>string</span> userId){...}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> SetUser(<span style=color:#66d9ef>string</span> userId, UserEntity entity){...}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// API</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[ApiController]</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;[Controller]</span><span style=color:#e6db74>&#34;)]  
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> : ControllerBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IUserService _service;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> UserController(IUserService service)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_service = service;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>	[HttpGet(&#34;{userId}&#34;)]</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> IActionResult Get(<span style=color:#66d9ef>string</span> userId)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> user = _service.GetUser(userId);
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>	[HttpPost(&#34;{userId}&#34;)]</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> IActionResult Post(<span style=color:#66d9ef>string</span> userId, [FromBody] UserEntity entity)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_service.SetUser(userId, entity);
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也就是將上述的程式，變更如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// IUserService</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IUserService</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	UserEntity GetUser();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> SetUser(UserEntity entity);
</span></span><span style=display:flex><span>	etc...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserService</span>: IUserService
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>string</span> _userId;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> UserService(<span style=color:#66d9ef>string</span> userId)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_userId = userId
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> UserEntity GetUser(<span style=color:#66d9ef>string</span> userId){...}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> SetUser(<span style=color:#66d9ef>string</span> userId, UserEntity entity){...}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// API</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[ApiController]</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;[Controller]</span>/{userId}<span style=color:#e6db74>&#34;)]  
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserController</span> : ControllerBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IUserService _service;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> UserController(IUserService service)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_service = service;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>	[HttpGet]</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> IActionResult Get()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> user = _service.GetUser();
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>	[HttpPost)]</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> IActionResult Post(<span style=color:#66d9ef>string</span> userId, [FromBody] UserEntity entity)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_service.SetUser(entity);
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=實作>實作</h2><p>在完成 Webapi 與 Service 的調整後，最重要的地方，就是如何讓 <a href=https://github.com/aspnet/DependencyInjection>Microsoft.Extensions.DependencyInjection</a> 注入 <code>userId</code> 的參數資訊。</p><p>在 <a href=https://eandev.com/post/develop/di-service-provider-httpcontextaccessor/>使用 DI 注入時，使用 Request 的參數，建立不同參數的物件</a> 這篇文章，提到可以使用 <code>HttpContextAccessor</code>，但當初是直接在 ASP.NET Core 內的 <code>Program.cs</code> 內，直接調用 ServiceProvider 取得 <code>IHttpContextAccessor</code>。</p><p>不過，這在這邊，我們已經把 Service 的 DI 設定，移到 Business.dll 的 DIExtension 中。那需要如何把所需的 <code>userId</code> 傳入呢？</p><p>因為 <code>userId</code> 資料，是調用 HttpContextAccessor 從 Route 中取得的資訊，所以別忘了在 <code>Program.cs</code> 加入<code>AddHttpContextAccessor</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>// Program</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在 DI 之中，增加 HttpContextAccessor</span>
</span></span><span style=display:flex><span>builder.Services.AddHttpContextAccessor();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DI Service</span>
</span></span><span style=display:flex><span>builder.Services.AddServices();
</span></span></code></pre></div><h3 id=作法一-直接調用-ihttpcontextaccessor>作法一: 直接調用 IHttpContextAccessor</h3><p>再不想公開 Service 的實作下，也可以把 IHttpContextAccessor 的運用，移到 DIExtension 內。使用 <code>ServiceProvider.GetService&lt;IHttpContextAccessor></code> 的功能，取得 HttpContextAccessor。</p><p>注意：需要加入 <code>Microsoft.AspNetCore.Http</code> Nuget 套件，否則無法識別 IHttpContextAccessor。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DiExtension</span>  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> AddServices(<span style=color:#66d9ef>this</span> IServiceCollection services)  
</span></span><span style=display:flex><span>	{  
</span></span><span style=display:flex><span>		services.AddScoped&lt;IUserService&gt;(provider =&gt;
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> accessor = provider.GetService&lt;IHttpContextAccessor&gt;();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> userId  = (<span style=color:#66d9ef>string?</span>)accessor?.HttpContext?.GetRouteData().Values[<span style=color:#e6db74>&#34;userId&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> UserService(userId);
</span></span><span style=display:flex><span>		});  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>雖然，這樣就可以直接取得 HttpContext 內的資訊。</p><p>但缺點是</p><ul><li>在 Business.dll 內，通常不會知道外部的參數是如何取得的。若今天 API 的 Route 異動，也需要異動 Business.dll。這會造成 Business.dll 與 api 的耦合。</li></ul><h3 id=作法二-將-di-所需要的參數封裝>作法二: 將 DI 所需要的參數封裝</h3><p>若要避免在 DIExtension 中實作取參數，可藉由 interface 來取得所需的參數。而實際負責取得參數資訊的實作，就直接放在 ASP.NET WebApi 專案內。</p><p>最後的專案結構如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Solution
</span></span><span style=display:flex><span>├─ WebApi (ASP.NET Core)
</span></span><span style=display:flex><span>├─ BusinessLogic.Common (Library)
</span></span><span style=display:flex><span>└─ BusinessLogic (Library)
</span></span></code></pre></div><p>首先，在建立一個共用的 Library (BusinessLogic.Common)，並建立 interface。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IParameterService</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>string</span> GetUserId();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接著，在 WebApi 內，進行 <code>IParamterService</code> 的實作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ParameterService</span> : IParameterService  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IHttpContextAccessor _accessor;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ParameterService(IHttpContextAccessor accessor)  
</span></span><span style=display:flex><span>	{  
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>._accessor = accessor;  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> GetUserId()  
</span></span><span style=display:flex><span>	{  
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> userId = (<span style=color:#66d9ef>string?</span>)<span style=color:#66d9ef>this</span>._accessor.HttpContext?.GetRouteData().Values[<span style=color:#e6db74>&#34;userId&#34;</span>];  
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> userId ?? <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentNullException(nameof(userId));  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最後，再調整 BusinessLogic 內的 DIExtension 即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DiExtension</span>  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> AddServices(<span style=color:#66d9ef>this</span> IServiceCollection services)  
</span></span><span style=display:flex><span>	{  
</span></span><span style=display:flex><span>		services.AddScoped&lt;IUserService&gt;(provider =&gt;
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> service = provider.GetService&lt;IParameterService&gt;();
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> userId  = service.GetUserId();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> UserService(userId);
</span></span><span style=display:flex><span>		});  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=延伸閱讀>延伸閱讀</h2><ul><li>[使用 DI 注入時，使用 Request 的參數，建立不同參數的物件]({&lt; ref &ldquo;使用 DI 注入時，使用 Request 的參數，建立不同參數的物件&rdquo; >})</li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/asp.net-core/ rel=tag>ASP.NET Core</a>
<a class=tag href=/tags/di/ rel=tag>DI</a></ul></div></footer><hr><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feandev.com%2fpost%2fdevelop%2fdi-encapsulate-service-and-use-external-parameters%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.min.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/devops/manual-adjuest-nlog-post-to-loki/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>NLog | 奇淫怪招 | 在不異動程式本體的前提下，手動讓 NLog post log 到 Loki</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/develop/dfcore-dbcontext-hasqueryfilter/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>EFCore | 使用 HasQueryFilter 限定 DBContext 查詢內容</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div></body></html>