<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="在本機同時使用 Docker 建立 GitLab 與 GitLab-Runner 時，在設定上遇到很多小眉腳。特別記錄下來，減少其他人撞牆的情況。"><meta property="og:title" content="GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner"><meta property="og:description" content="在本機同時使用 Docker 建立 GitLab 與 GitLab-Runner 時，在設定上遇到很多小眉腳。特別記錄下來，減少其他人撞牆的情況。"><meta property="og:type" content="article"><meta property="og:url" content="https://eanlee.github.io/post/devops/gitlab_ci_same_host/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-31T15:58:45+00:00"><meta property="article:modified_time" content="2022-09-12T02:20:15+00:00"><meta itemprop=name content="GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner"><meta itemprop=description content="在本機同時使用 Docker 建立 GitLab 與 GitLab-Runner 時，在設定上遇到很多小眉腳。特別記錄下來，減少其他人撞牆的情況。"><meta itemprop=datePublished content="2022-08-31T15:58:45+00:00"><meta itemprop=dateModified content="2022-09-12T02:20:15+00:00"><meta itemprop=wordCount content="961"><meta itemprop=keywords content="GitLab,"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner"><meta name=twitter:description content="在本機同時使用 Docker 建立 GitLab 與 GitLab-Runner 時，在設定上遇到很多小眉腳。特別記錄下來，減少其他人撞牆的情況。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-08-31T15:58:45Z>2022-08-31</time>
<time class=meta__text datetime=2022-09-12T02:20:15Z>(Last Modified: 2022-09-12)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/devops/ rel=category>DevOps</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#建立-gitlab-server>建立 GitLab Server</a></li><li><a href=#註冊-gitlab-runner>註冊 GitLab-Runner</a></li><li><a href=#非預設-80-port-的建議作法>非預設 80 Port 的建議作法</a></li><li><a href=#使用-docker-compose-直接在本機建立-gitlab-server-與-runner>使用 Docker-compose 直接在本機建立 GitLab Server 與 Runner</a></li><li><a href=#進行-gitlab-ci-測試>進行 GitLab CI 測試</a></li><li><a href=#補充資料>補充資料</a><ul><li><a href=#延伸閱讀>延伸閱讀</a></li><li><a href=#參考資料>參考資料</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>最近因為業務需求，必需在私有環境架設版控平台，並需要 CI/CD 的功能。</p><p>在朋友的推薦下，開始初次使用 GitLab。因為對 GitLab 的架設與設定還不熟悉，所以先在本機進行 POC 測試。</p><p>為了減少架設的複雜性，所以選擇使用 GitLab 的 Docker Image 來建立服務。此次使用的軟體版本如下</p><ul><li>OS: Windows 11</li><li>GitLab Server: GitLab CE Community 15.0.4-ce.0</li><li>GitLab Runner ver.1.5.1</li></ul><p>📣 TL;DR</p><p>在同一台機器內，使用 Dokcer 同時架設 GitLab 與 GitLab-Runner 有一些地方要注意。</p><ul><li>若 GitLab Runner 使用 Docker Executor，需要指定使用的網路。</li><li>若 GitLab 使用 <code>localhost</code>，註冊 GitLab-Runner 時，需特別指定 <code>clone_url</code>。</li><li>若 GitLab 若不是使用 80 Port，務必依官方建議作法，可以減少很多麻煩。</li><li>Docker network 的部份要特別小心。</li></ul><h2 id=建立-gitlab-server>建立 GitLab Server</h2><p>一開始，直接採用網路文章的方法，進行 GitLab 的建置，確實很快的完成建置動作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 不建議直接使用，後續進行 Git Clone 會出現網址的問題</span>
</span></span><span style=display:flex><span>docker run -d --name gitlab -p 8080<span style=color:#960050;background-color:#1e0010>:</span>80 --restart always gitlab/gitlab-ce
</span></span></code></pre></div><p><img src=gitlab_sigin_in.png alt="GitLab sign-in"></p><p>此時會遇到第一個問題，就是不知道登入的密碼是什麼？</p><p>因為使用 Docker 建立出來的 GitLab，<code>root</code> 預設密碼並不是 <del><code>5iveL! fe</code></del>。需要使用下述指令取得 Continer 內，預設的 <code>root</code>的密碼。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 取得 Container 內的 root 預設密碼</span>
</span></span><span style=display:flex><span>docker exec -it gitlab grep <span style=color:#e6db74>&#39;Password:&#39;</span> /etc/gitlab/initial_root_password
</span></span></code></pre></div><p><img src=docker_gitlab_initial_root_pwd.png alt="root 預設密碼"></p><p>順利登入後，新建立一個名為 Test 的 Repository 後，點選 <code>Clone</code> 按鈕後，會發現 <code>Clone with HTTP</code> 路徑為 <code>http://d04070f2213e/[Repository-Name]/test.git</code>。</p><p><img src=gitlab_clone_http_bad.png alt="clone path"></p><p>其實，下載的網址內出現的 <code>d04070f2213e</code> 字串，其實是 CONTAINER ID。</p><p><img src=docker_ps_only_gitlab.png alt="docker ps"></p><p>但實務上，這樣的網址是無直接使用，變成每次需要手動調整更正為主機 Domain Name 或 IP。為避免這個問題，還是乖乖的參考官方文件 <a href=https://docs.gitlab.com/ee/install/docker.html#install-gitlab-using-docker-engine>GitLab Docker images</a> 的說明。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>docker run --detach \
</span></span><span style=display:flex><span>  --hostname localhost \
</span></span><span style=display:flex><span>  --publish 443<span style=color:#960050;background-color:#1e0010>:</span>443 --publish 80<span style=color:#960050;background-color:#1e0010>:</span>80 --publish 22<span style=color:#960050;background-color:#1e0010>:</span>22 \
</span></span><span style=display:flex><span>  --name gitlab \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/config<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/logs<span style=color:#960050;background-color:#1e0010>:</span>/var/log/gitlab \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/data<span style=color:#960050;background-color:#1e0010>:</span>/var/opt/gitlab \
</span></span><span style=display:flex><span>  --shm-size 256m \
</span></span><span style=display:flex><span>  gitlab/gitlab-ee<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>在 GitLab 的 Container 建立時，預設使用 22、80、443 三個 Port。</p><ul><li>Port 443 是 HTTPS (TLS) 使用</li><li>Port 80 是 HTTP 使用</li><li>Port 22 是 SSH 使用</li></ul><p>為了確保後續容易搬移與備份資料，所以額外建立 docker volume。同時，因為本機 80 Port 已經被其他網站使用，所以改用 8080 Port。</p><p>調整後的指令如下.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create volume</span>
</span></span><span style=display:flex><span>docker volume create gitlab_data
</span></span><span style=display:flex><span>docker volume create gitlab_opt
</span></span><span style=display:flex><span>docker volume create gitlab_log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 建立使用 8080 Port 與自建 Volume 的 Container</span>
</span></span><span style=display:flex><span>docker run --detach \
</span></span><span style=display:flex><span>  --hostname localhost \
</span></span><span style=display:flex><span>  --publish 8080<span style=color:#960050;background-color:#1e0010>:</span>80 \
</span></span><span style=display:flex><span>  --name gitlab \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  --volume gitlab_data<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab \
</span></span><span style=display:flex><span>  --volume gitlab_log<span style=color:#960050;background-color:#1e0010>:</span>/var/log/gitlab \
</span></span><span style=display:flex><span>  --volume gitlab_opt<span style=color:#960050;background-color:#1e0010>:</span>/var/opt/gitlab \
</span></span><span style=display:flex><span>  --shm-size 256m gitlab/gitlab-ee<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>重新建立好之後，再觀察 <code>Clone with HTTP</code>，就會變成預期的 Hostname。</p><p><img src=clone_localhost.png alt="git clone path"></p><p>但是直接使用 <code>Clone with HTTP</code> 的路徑，還是無法成功使用。</p><p>在使用上，還是需要手動加入 Port 才能正常 Clone Repository 的內容。這邊就到此為止，暫不處理此問題。</p><p>針對使用不同的 Port，官方建議的設定作法可見 <a href=#%E9%9D%9E%E9%A0%90%E8%A8%AD-80-port-%E7%9A%84%E5%BB%BA%E8%AD%B0%E4%BD%9C%E6%B3%95>非預設-80-port-的建議作法</a>。</p><h2 id=註冊-gitlab-runner>註冊 GitLab-Runner</h2><p>首先使用 GitLab-Runner 的 Docker Image，將 Runner 的服務架設起來。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create Volume</span>
</span></span><span style=display:flex><span>docker volume create gitlab-runner-config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 啟用 GitLab-Runner</span>
</span></span><span style=display:flex><span>docker run -d \
</span></span><span style=display:flex><span>  --name gitlab-runner \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  -v /var/run/docker.sock<span style=color:#960050;background-color:#1e0010>:</span>/var/run/docker.sock \
</span></span><span style=display:flex><span>  -v gitlab-runner-config<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab-runner \
</span></span><span style=display:flex><span>  gitlab/gitlab-runner<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>接著，向 GitLab Server 註冊 Giblab-Runner，讓 GitLab 知道有那些 Runner 可以使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 進行 Runner 註冊</span>
</span></span><span style=display:flex><span>docker exec -it gitlab-runner gitlab-runner register
</span></span></code></pre></div><p>在註冊過程中，會有訊息提供，要求依序輸入 <code>GitLab Url</code>、<code>Token</code>、<code>Runner 的描述</code>、<code>Runner's tags</code>、<code>Runner's maintain note</code>、<code>Executor</code> 等資訊。</p><p>在 GitLab 的 Runner 可註冊為共用的 <code>Shared Runner</code> 或傞供專案本身使用的 <code>Runner</code>。</p><p>在註冊專案本身使用的 Runner 時，所需的 <code>Url</code> 與 <code>Token</code>，可以從專案的 <code>Settings > CI/CD</code> 的 <code>Runners</code> 取得。</p><p><img src=gitlab_registor_runner.png alt="Runner setting"></p><p>⚠️ 在註冊過程中，會發生會發生 <code>connect refuse</code> 的問題。</p><p><img src=runnerj_register_failed.png alt="runner registory fail: connect refuse"></p><p>從上面可以看到 <code>連線到 127.0.0.1:8080 被拒</code> 的異常訊息，若對 docker network 概念不熟悉的話，可能會在這邊卡住，無法理解，為何無法連線？</p><p>簡單說明一下，在 Docker 內的 Network 分為 <code>bridge</code>、<code>overlay</code>、<code>ipvlan</code>、<code>macvlan</code>、<code>none</code> 等類型。預設是使用 <code>brige</code> 的類型。</p><p>用圖來理解目前的 Container 的網路架構。</p><p><img src=docker_network.png alt=network></p><p>在了解網路架構後，有兩種調整的做法。分別為硬幹型與標準型。</p><p>🔲 硬幹型作法:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 顯示 GitLab 的網路設定</span>
</span></span><span style=display:flex><span>docker inspect <span style=color:#f92672>-f</span> <span style=color:#e6db74>&#39;{{json .NetworkSettings.Networks}}&#39;</span> gitlab
</span></span></code></pre></div><p><img src=gitlab_container_networkSetting.png alt="network setting of gitlab container"></p><p>發現 GitLab container 在 Bridge 內配的 IP 為 <code>172.17.0.2</code>，Gateway 為 <code>172.17.0.1</code>，在註冊 Runner 時，<code>GitLab Url</code> 位置的設定方式有兩種</p><ul><li>使用 IP: 因為 GitLab 預設使用 80 Port，直接輸入 <code>http://172.17.0.2</code>，就可以成功從 GitLab-Runner 連入 GitLab。</li><li>使用 Gateway: 輸入 <code>http://172.17.0.1:8080/</code>。簡單來說，Bridge 會依據 Container 建立時的設定，傳導至 GitLab Continer。這邊原理比較複雜，再另外說明。</li></ul><p><img src=register_runner_success.png alt="runner registory success"></p><p>成功註冊後，再重新整理 <code>Setting > CI/CD</code> 的頁面，會發現原先 Runner 的項目下，出現方才新的 Runner。</p><p><img src=gitlab_specific_Runner.png alt="specific runner"></p><p>☑ 標準的作法(建議):</p><p>若使用預設的 Bridge 網路，Container 若要與另一個 Container 建立連線，只能使用 IP 的方式。</p><p><a href=https://docs.docker.com/network/bridge/#use-the-default-bridge-network>官方文件</a>中也提到，使用自定義的 Bridge 網路 (User-defined bridge networks) 優於 default bridge，同時有以下幾點好處。</p><ul><li>User-defined bridges provide automatic DNS resolution between containers.</li><li>User-defined bridges provide better isolation.</li><li>Containers can be attached and detached from user-defined networks on the fly.</li><li>Each user-defined network creates a configurable bridge.</li><li>Linked containers on the default bridge network share environment variables.</li></ul><p>所以，我們來建立 GitLab 專用的 Bridge 網路吧。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>docker network create --driver bridge gitlab-network
</span></span></code></pre></div><p>若是 Container 還沒建立之前，可在建立 Container 時，加入參數 <code>--network gitlab-network</code>。</p><p>由於先前已建立 <code>GitLab</code> 與 <code>GitLab-Runner</code> 兩個 Container，所以接下來要變更這兩個 Container 使用的網路設定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 停止 Contianer</span>
</span></span><span style=display:flex><span>docker stop gitlab, gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 加入 gitlab-network 網路</span>
</span></span><span style=display:flex><span>docker network disconnect gitlab-network gitlab
</span></span><span style=display:flex><span>docker network disconnect gitlab-network gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 移除 bridbe 網路</span>
</span></span><span style=display:flex><span>docker network disconnect bridge gitlab
</span></span><span style=display:flex><span>docker network disconnect bridge gitlab-runner
</span></span></code></pre></div><p>此次再檢視預設 Bridge 網路的內容，可以發現 GitLab 與 GitLab-Runner 兩個 Container 已不在其中。</p><p><img src=default_gridge_network_nouse.png alt="default gridge network"></p><p>而在 <code>gitlab-network</code> 的 bridge 網路中，可以找到兩個 Container。</p><p><img src=user-define-bridge-network.png alt="User-Defined gridge network"></p><p>再次進行 Runner 的註冊時，<code>GitLab Url</code> 就可以使用 DNS 的方式指到 GitLab Container。</p><p><img src=runner_register_success_2.png alt="runner registory success"></p><p>⚠️ 補充：在 GitLab-Runner 的 Container 內，<code>/etc/hosts</code> 內已定義 <code>localhost</code>，所以在註冊時使用 localhost 必定會失敗。</p><h2 id=非預設-80-port-的建議作法>非預設 80 Port 的建議作法</h2><p>上面花了很多功夫在處理 Docker PortBinding 不同，所造成的延伸問題。其實可以參考<a href=https://docs.gitlab.com/ee/install/docker.html#expose-gitlab-on-different-ports>官方文件</a>，減少 <code>Clone</code> 時，路徑造成的問題。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-docker data-lang=docker><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>docker run --detach <span style=color:#ae81ff>\
</span></span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ae81ff></span>  --hostname gitlab.example.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ae81ff></span>  --publish 8929:8929 --publish 2289:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ae81ff></span>  --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ae81ff></span>  --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/config:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/logs:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/data:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ae81ff></span>  --shm-size 256m <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ae81ff></span>  gitlab/gitlab-ee:latest<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>有兩個重點參數 <code>--hostanme</code> 與 <code>--publish</code>，在 publish 的 PortBinding 時，盡可能使用相同的 Port，這樣可以減少很多麻煩。</p><p>在啟動 Container 後，接著進入 Container 內，進行 <code>etc\gitlab\gitlab.rb</code> 的調整。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 執行 GitLab&#39;s Container 內的 bash，並與其互動</span>
</span></span><span style=display:flex><span>docker exec -it gitlab /bin/bash
</span></span></code></pre></div><p>順帶一提，GitLab 的 Docker Image 建立的 Container，未安裝 vim，若要使用 vim 進行 <code>gitlab.rb</code> 的內容修改，需額外進行安裝 vim。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rb data-lang=rb><span style=display:flex><span><span style=color:#75715e># For HTTP/HTTPS</span>
</span></span><span style=display:flex><span>external_url <span style=color:#e6db74>&#34;http://gitlab.example.com:8929&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 設定 SSH 所使用的 Port</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;gitlab_shell_ssh_port&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2289</span>
</span></span></code></pre></div><p>完成修改後，記得要套用修改後的設定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 重新套用 gitlab.rb 的設定</span>
</span></span><span style=display:flex><span>gitlab-ctl reconfigure
</span></span></code></pre></div><h2 id=使用-docker-compose-直接在本機建立-gitlab-server-與-runner>使用 Docker-compose 直接在本機建立 GitLab Server 與 Runner</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># docker-compose.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.7&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gitlab/gitlab-ce:latest&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#39;localhost&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>gitlab-ce</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>GITLAB_OMNIBUS_CONFIG</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span>        <span style=color:#ae81ff>external_url &#39;http://localhost&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8080:80&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8443:443&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/config:/etc/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/logs:/var/log/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/data:/var/opt/gitlab&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>gitlab</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gitlab-runner</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gitlab/gitlab-runner:alpine</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>gitlab-runner    </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/gitlab-runner:/etc/gitlab-runner&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>gitlab</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gitlab</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitlab-network</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 使用 docker-compose.yml 啟動 Container</span>
</span></span><span style=display:flex><span>docker-compse -d up
</span></span></code></pre></div><h2 id=進行-gitlab-ci-測試>進行 GitLab CI 測試</h2><p>接著，來撰寫 GitLab CI 的執行腳本。到 <code>CI/CD > Editor</code> 內進行 <code>.gitlab-ci.yml</code> 的編輯，我們直接使用預設產生的內容進行測試。</p><p><img src=gitlab_ci_editor.png alt="CD/CD Editor"></p><p>⚠️ 此時會發現 CI 卡住。一直在 <code>Pending</code>，這是因為 <code>.gitlab-ci.yml</code> 內未指定 Runner Tag，GitLab CI 找不到可以用的 Runner。</p><p><img src=ci_pending.png alt="CI Pending">
<img src=ci_pending_2.png alt="CI Pending 2"></p><p>所以需要到 <code>Settings > CI/CD</code> 的 Runner，將負責 CI 的 Runner 進行的設定變更，勾選 <code>Run Untagged Job</code> 即可。</p><p><img src=gitlab_setting_runner_edit.png alt="runner edit"><br><img src=edit_runner_untagged.png alt="runner edit"></p><p>接著 Redo 之前的 CI Job，還是發生錯誤。</p><p><img src=cannot_pull_git.png alt="can&amp;rsquo;t pull git"></p><p>⚠️ Runner 回應 git 的路徑不正確，無法連線。因此，需要額外在 GitLab-runner 的 <code>etc\gitlab-runner\config.toml</code> 中，加入參數 <code>clone-url</code>。</p><p><img src=clone_url.png alt="add clone url"></p><p>調整完成後，記得要重置 GitLab-Runner。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 重置 gitlab-runner，套用變更的設定</span>
</span></span><span style=display:flex><span>gitlab-runner restart
</span></span></code></pre></div><p>接著 Redo 之前的 CI Job，持續發生錯誤。</p><p><img src=gitlab_job_fail_not_resolve_host.png alt="Can&amp;rsquo;t reslove host"></p><p>此時的錯誤是無法 Runner 無法解析 DNS。若是 GitLab-runner 的 Executor 指定 Docker，必須告知 Docker Executor 使用的網路。</p><p>在 <code>etc\gitlab-runner\config.toml</code> 的 <code>runners.docker</code> 加入 <code>network_mode</code> 後，記得要重置 GitLab-Runner。</p><p><img src=add_docker_runner_network.png alt="add netowrk_mode "></p><p>再 Redo 之前的 CI Job，終於成功了。</p><p><img src=gitlab_ci_job_success.png alt="CI success"></p><p>若不想要進到 config.toml 進行參數的調整，也可以在註冊 Runner 加入參數 <code>--clone-url</code> 與 <code>--docker-network-mode</code> 的參數。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 註冊 GitLab-Runner 時，傳入參數</span>
</span></span><span style=display:flex><span>docker exec -it gitlab-runner gitlab-runner register \
</span></span><span style=display:flex><span>  --clone-url [gitlab-host] \
</span></span><span style=display:flex><span>  --executor docker \
</span></span><span style=display:flex><span>  --docker-network-mode [network-name]
</span></span></code></pre></div><h2 id=補充資料>補充資料</h2><h3 id=延伸閱讀>延伸閱讀</h3><ul><li>艦長，你有事嗎？, <a href=https://chengweichen.com/2021/03/gitlab-ci-executor.html>GitLab CI 之 Runner 的 Executor 該如何選擇？</a></li><li>datawookie, <a href=https://datawookie.dev/blog/2021/03/install-gitlab-runner-with-docker/>Install GitLab Runner with Docker</a></li><li>SALMON&rsquo;S BLOG, <a href=https://blog.salmon.tw/2018/05/08/%E8%A8%BB%E5%86%8A%20GitLab%20Runner/>註冊 GitLab Runner</a></li><li>Rick&rsquo;s Blog, <a href=https://www.rickjiang.dev/blog/gitlab-and-gitlab-runner-with-docker>利用 Docker 建置 GitLab + GitLab Runner</a></li><li>Patrycjusz Czerniga, <a href=https://www.czerniga.it/2021/11/14/how-to-install-gitlab-using-docker-compose/>How to install GitLab using Docker Compose?</a></li><li>MIRANTIS, <a href=https://docs.mirantis.com/containers/v3.0/dockeree-ref-arch/networking/scalable-container-networks.html>Exploring Scalable, Portable Docker Swarm Container Networks</a></li></ul><h3 id=參考資料>參考資料</h3><ul><li>Stackoverflow, <a href=https://stackoverflow.com/questions/53370840/sthis-job-is-stuck-because-the-project-doesnt-have-any-runners-online-assigned>This job is stuck, because the project doesn&rsquo;t have any runners online assigned to it. Go to Runners page</a></li><li>Stackoverflow, <a href=https://stackoverflow.com/questions/50325932/gitlab-runner-docker-could-not-resolve-host>GitLab runner docker Could not resolve host</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/gitlab/ rel=tag>GitLab</a></ul></div></footer><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feanlee.github.io%2fpost%2fdevops%2fgitlab_ci_same_host%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/series/build_automated_deploy/container_intro/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>部署新境界 - 使用 Container 簡化流程</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/devops/gitlab_ci_network/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>