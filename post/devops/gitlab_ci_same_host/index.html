<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>GitLab CI å¯¦ä½œè¨˜éŒ„(1) - ä½¿ç”¨ Docker åœ¨åŒå°ä¸»æ©Ÿé‹è¡Œ GitLab èˆ‡ GitLab-Runner - ä¼Šæ©çš„é–‹ç™¼ç‹‚æƒ³</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="åœ¨æœ¬æ©ŸåŒæ™‚ä½¿ç”¨ Docker å»ºç«‹ GitLab èˆ‡ GitLab-Runner æ™‚ï¼Œåœ¨è¨­å®šä¸Šé‡åˆ°å¾ˆå¤šå°çœ‰è…³ã€‚ç‰¹åˆ¥è¨˜éŒ„ä¸‹ä¾†ï¼Œæ¸›å°‘å…¶ä»–äººæ’ç‰†çš„æƒ…æ³ã€‚"><meta property="og:title" content="GitLab CI å¯¦ä½œè¨˜éŒ„(1) - ä½¿ç”¨ Docker åœ¨åŒå°ä¸»æ©Ÿé‹è¡Œ GitLab èˆ‡ GitLab-Runner"><meta property="og:description" content="åœ¨æœ¬æ©ŸåŒæ™‚ä½¿ç”¨ Docker å»ºç«‹ GitLab èˆ‡ GitLab-Runner æ™‚ï¼Œåœ¨è¨­å®šä¸Šé‡åˆ°å¾ˆå¤šå°çœ‰è…³ã€‚ç‰¹åˆ¥è¨˜éŒ„ä¸‹ä¾†ï¼Œæ¸›å°‘å…¶ä»–äººæ’ç‰†çš„æƒ…æ³ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://eanlee.github.io/post/devops/gitlab_ci_same_host/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-31T15:58:45+00:00"><meta property="article:modified_time" content="2022-09-12T02:20:15+00:00"><meta itemprop=name content="GitLab CI å¯¦ä½œè¨˜éŒ„(1) - ä½¿ç”¨ Docker åœ¨åŒå°ä¸»æ©Ÿé‹è¡Œ GitLab èˆ‡ GitLab-Runner"><meta itemprop=description content="åœ¨æœ¬æ©ŸåŒæ™‚ä½¿ç”¨ Docker å»ºç«‹ GitLab èˆ‡ GitLab-Runner æ™‚ï¼Œåœ¨è¨­å®šä¸Šé‡åˆ°å¾ˆå¤šå°çœ‰è…³ã€‚ç‰¹åˆ¥è¨˜éŒ„ä¸‹ä¾†ï¼Œæ¸›å°‘å…¶ä»–äººæ’ç‰†çš„æƒ…æ³ã€‚"><meta itemprop=datePublished content="2022-08-31T15:58:45+00:00"><meta itemprop=dateModified content="2022-09-12T02:20:15+00:00"><meta itemprop=wordCount content="961"><meta itemprop=keywords content="GitLab,"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab CI å¯¦ä½œè¨˜éŒ„(1) - ä½¿ç”¨ Docker åœ¨åŒå°ä¸»æ©Ÿé‹è¡Œ GitLab èˆ‡ GitLab-Runner"><meta name=twitter:description content="åœ¨æœ¬æ©ŸåŒæ™‚ä½¿ç”¨ Docker å»ºç«‹ GitLab èˆ‡ GitLab-Runner æ™‚ï¼Œåœ¨è¨­å®šä¸Šé‡åˆ°å¾ˆå¤šå°çœ‰è…³ã€‚ç‰¹åˆ¥è¨˜éŒ„ä¸‹ä¾†ï¼Œæ¸›å°‘å…¶ä»–äººæ’ç‰†çš„æƒ…æ³ã€‚"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=ä¼Šæ©çš„é–‹ç™¼ç‹‚æƒ³ rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>ä¼Šæ©çš„é–‹ç™¼ç‹‚æƒ³</div><div class=logo__tagline>åœ¨çŸ¥è­˜å¤§æµ·ä¸­æ¼‚æµçš„å°èˆ¹ï¼Œä¸åœè¿½å°‹å±¬æ–¼è‡ªå·±çš„ç§˜å¯¶ã€‚å°ˆæ³¨æ–¼ .NETã€é›²ç«¯æŠ€è¡“ã€ç³»çµ±æ¶æ§‹ã€é–‹ç™¼æŠ€å·§çš„é“ã€æ³•ã€è¡“ã€‚</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>GitLab CI å¯¦ä½œè¨˜éŒ„(1) - ä½¿ç”¨ Docker åœ¨åŒå°ä¸»æ©Ÿé‹è¡Œ GitLab èˆ‡ GitLab-Runner</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>ä¼Šæ©</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-08-31T15:58:45Z>2022-08-31</time>
<time class=meta__text datetime=2022-09-12T02:20:15Z>(Last Modified: 2022-09-12)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/devops/ rel=category>DevOps</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#å»ºç«‹-gitlab-server>å»ºç«‹ GitLab Server</a></li><li><a href=#è¨»å†Š-gitlab-runner>è¨»å†Š GitLab-Runner</a></li><li><a href=#éé è¨­-80-port-çš„å»ºè­°ä½œæ³•>éé è¨­ 80 Port çš„å»ºè­°ä½œæ³•</a></li><li><a href=#ä½¿ç”¨-docker-compose-ç›´æ¥åœ¨æœ¬æ©Ÿå»ºç«‹-gitlab-server-èˆ‡-runner>ä½¿ç”¨ Docker-compose ç›´æ¥åœ¨æœ¬æ©Ÿå»ºç«‹ GitLab Server èˆ‡ Runner</a></li><li><a href=#é€²è¡Œ-gitlab-ci-æ¸¬è©¦>é€²è¡Œ GitLab CI æ¸¬è©¦</a></li><li><a href=#è£œå……è³‡æ–™>è£œå……è³‡æ–™</a><ul><li><a href=#å»¶ä¼¸é–±è®€>å»¶ä¼¸é–±è®€</a></li><li><a href=#åƒè€ƒè³‡æ–™>åƒè€ƒè³‡æ–™</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>æœ€è¿‘å› ç‚ºæ¥­å‹™éœ€æ±‚ï¼Œå¿…éœ€åœ¨ç§æœ‰ç’°å¢ƒæ¶è¨­ç‰ˆæ§å¹³å°ï¼Œä¸¦éœ€è¦ CI/CD çš„åŠŸèƒ½ã€‚</p><p>åœ¨æœ‹å‹çš„æ¨è–¦ä¸‹ï¼Œé–‹å§‹åˆæ¬¡ä½¿ç”¨ GitLabã€‚å› ç‚ºå° GitLab çš„æ¶è¨­èˆ‡è¨­å®šé‚„ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥å…ˆåœ¨æœ¬æ©Ÿé€²è¡Œ POC æ¸¬è©¦ã€‚</p><p>ç‚ºäº†æ¸›å°‘æ¶è¨­çš„è¤‡é›œæ€§ï¼Œæ‰€ä»¥é¸æ“‡ä½¿ç”¨ GitLab çš„ Docker Image ä¾†å»ºç«‹æœå‹™ã€‚æ­¤æ¬¡ä½¿ç”¨çš„è»Ÿé«”ç‰ˆæœ¬å¦‚ä¸‹</p><ul><li>OS: Windows 11</li><li>GitLab Server: GitLab CE Community 15.0.4-ce.0</li><li>GitLab Runner ver.1.5.1</li></ul><p>ğŸ“£ TL;DR</p><p>åœ¨åŒä¸€å°æ©Ÿå™¨å…§ï¼Œä½¿ç”¨ Dokcer åŒæ™‚æ¶è¨­ GitLab èˆ‡ GitLab-Runner æœ‰ä¸€äº›åœ°æ–¹è¦æ³¨æ„ã€‚</p><ul><li>è‹¥ GitLab Runner ä½¿ç”¨ Docker Executorï¼Œéœ€è¦æŒ‡å®šä½¿ç”¨çš„ç¶²è·¯ã€‚</li><li>è‹¥ GitLab ä½¿ç”¨ <code>localhost</code>ï¼Œè¨»å†Š GitLab-Runner æ™‚ï¼Œéœ€ç‰¹åˆ¥æŒ‡å®š <code>clone_url</code>ã€‚</li><li>è‹¥ GitLab è‹¥ä¸æ˜¯ä½¿ç”¨ 80 Portï¼Œå‹™å¿…ä¾å®˜æ–¹å»ºè­°ä½œæ³•ï¼Œå¯ä»¥æ¸›å°‘å¾ˆå¤šéº»ç…©ã€‚</li><li>Docker network çš„éƒ¨ä»½è¦ç‰¹åˆ¥å°å¿ƒã€‚</li></ul><h2 id=å»ºç«‹-gitlab-server>å»ºç«‹ GitLab Server</h2><p>ä¸€é–‹å§‹ï¼Œç›´æ¥æ¡ç”¨ç¶²è·¯æ–‡ç« çš„æ–¹æ³•ï¼Œé€²è¡Œ GitLab çš„å»ºç½®ï¼Œç¢ºå¯¦å¾ˆå¿«çš„å®Œæˆå»ºç½®å‹•ä½œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># ä¸å»ºè­°ç›´æ¥ä½¿ç”¨ï¼Œå¾ŒçºŒé€²è¡Œ Git Clone æœƒå‡ºç¾ç¶²å€çš„å•é¡Œ</span>
</span></span><span style=display:flex><span>docker run -d --name gitlab -p 8080<span style=color:#960050;background-color:#1e0010>:</span>80 --restart always gitlab/gitlab-ce
</span></span></code></pre></div><p><img src=gitlab_sigin_in.png alt="GitLab sign-in"></p><p>æ­¤æ™‚æœƒé‡åˆ°ç¬¬ä¸€å€‹å•é¡Œï¼Œå°±æ˜¯ä¸çŸ¥é“ç™»å…¥çš„å¯†ç¢¼æ˜¯ä»€éº¼ï¼Ÿ</p><p>å› ç‚ºä½¿ç”¨ Docker å»ºç«‹å‡ºä¾†çš„ GitLabï¼Œ<code>root</code> é è¨­å¯†ç¢¼ä¸¦ä¸æ˜¯ <del><code>5iveL! fe</code></del>ã€‚éœ€è¦ä½¿ç”¨ä¸‹è¿°æŒ‡ä»¤å–å¾— Continer å…§ï¼Œé è¨­çš„ <code>root</code>çš„å¯†ç¢¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># å–å¾— Container å…§çš„ root é è¨­å¯†ç¢¼</span>
</span></span><span style=display:flex><span>docker exec -it gitlab grep <span style=color:#e6db74>&#39;Password:&#39;</span> /etc/gitlab/initial_root_password
</span></span></code></pre></div><p><img src=docker_gitlab_initial_root_pwd.png alt="root é è¨­å¯†ç¢¼"></p><p>é †åˆ©ç™»å…¥å¾Œï¼Œæ–°å»ºç«‹ä¸€å€‹åç‚º Test çš„ Repository å¾Œï¼Œé»é¸ <code>Clone</code> æŒ‰éˆ•å¾Œï¼Œæœƒç™¼ç¾ <code>Clone with HTTP</code> è·¯å¾‘ç‚º <code>http://d04070f2213e/[Repository-Name]/test.git</code>ã€‚</p><p><img src=gitlab_clone_http_bad.png alt="clone path"></p><p>å…¶å¯¦ï¼Œä¸‹è¼‰çš„ç¶²å€å…§å‡ºç¾çš„ <code>d04070f2213e</code> å­—ä¸²ï¼Œå…¶å¯¦æ˜¯ CONTAINER IDã€‚</p><p><img src=docker_ps_only_gitlab.png alt="docker ps"></p><p>ä½†å¯¦å‹™ä¸Šï¼Œé€™æ¨£çš„ç¶²å€æ˜¯ç„¡ç›´æ¥ä½¿ç”¨ï¼Œè®Šæˆæ¯æ¬¡éœ€è¦æ‰‹å‹•èª¿æ•´æ›´æ­£ç‚ºä¸»æ©Ÿ Domain Name æˆ– IPã€‚ç‚ºé¿å…é€™å€‹å•é¡Œï¼Œé‚„æ˜¯ä¹–ä¹–çš„åƒè€ƒå®˜æ–¹æ–‡ä»¶ <a href=https://docs.gitlab.com/ee/install/docker.html#install-gitlab-using-docker-engine>GitLab Docker images</a> çš„èªªæ˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>docker run --detach \
</span></span><span style=display:flex><span>  --hostname localhost \
</span></span><span style=display:flex><span>  --publish 443<span style=color:#960050;background-color:#1e0010>:</span>443 --publish 80<span style=color:#960050;background-color:#1e0010>:</span>80 --publish 22<span style=color:#960050;background-color:#1e0010>:</span>22 \
</span></span><span style=display:flex><span>  --name gitlab \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/config<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/logs<span style=color:#960050;background-color:#1e0010>:</span>/var/log/gitlab \
</span></span><span style=display:flex><span>  --volume $GITLAB_HOME/data<span style=color:#960050;background-color:#1e0010>:</span>/var/opt/gitlab \
</span></span><span style=display:flex><span>  --shm-size 256m \
</span></span><span style=display:flex><span>  gitlab/gitlab-ee<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>åœ¨ GitLab çš„ Container å»ºç«‹æ™‚ï¼Œé è¨­ä½¿ç”¨ 22ã€80ã€443 ä¸‰å€‹ Portã€‚</p><ul><li>Port 443 æ˜¯ HTTPS (TLS) ä½¿ç”¨</li><li>Port 80 æ˜¯ HTTP ä½¿ç”¨</li><li>Port 22 æ˜¯ SSH ä½¿ç”¨</li></ul><p>ç‚ºäº†ç¢ºä¿å¾ŒçºŒå®¹æ˜“æ¬ç§»èˆ‡å‚™ä»½è³‡æ–™ï¼Œæ‰€ä»¥é¡å¤–å»ºç«‹ docker volumeã€‚åŒæ™‚ï¼Œå› ç‚ºæœ¬æ©Ÿ 80 Port å·²ç¶“è¢«å…¶ä»–ç¶²ç«™ä½¿ç”¨ï¼Œæ‰€ä»¥æ”¹ç”¨ 8080 Portã€‚</p><p>èª¿æ•´å¾Œçš„æŒ‡ä»¤å¦‚ä¸‹.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create volume</span>
</span></span><span style=display:flex><span>docker volume create gitlab_data
</span></span><span style=display:flex><span>docker volume create gitlab_opt
</span></span><span style=display:flex><span>docker volume create gitlab_log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å»ºç«‹ä½¿ç”¨ 8080 Port èˆ‡è‡ªå»º Volume çš„ Container</span>
</span></span><span style=display:flex><span>docker run --detach \
</span></span><span style=display:flex><span>  --hostname localhost \
</span></span><span style=display:flex><span>  --publish 8080<span style=color:#960050;background-color:#1e0010>:</span>80 \
</span></span><span style=display:flex><span>  --name gitlab \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  --volume gitlab_data<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab \
</span></span><span style=display:flex><span>  --volume gitlab_log<span style=color:#960050;background-color:#1e0010>:</span>/var/log/gitlab \
</span></span><span style=display:flex><span>  --volume gitlab_opt<span style=color:#960050;background-color:#1e0010>:</span>/var/opt/gitlab \
</span></span><span style=display:flex><span>  --shm-size 256m gitlab/gitlab-ee<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>é‡æ–°å»ºç«‹å¥½ä¹‹å¾Œï¼Œå†è§€å¯Ÿ <code>Clone with HTTP</code>ï¼Œå°±æœƒè®Šæˆé æœŸçš„ Hostnameã€‚</p><p><img src=clone_localhost.png alt="git clone path"></p><p>ä½†æ˜¯ç›´æ¥ä½¿ç”¨ <code>Clone with HTTP</code> çš„è·¯å¾‘ï¼Œé‚„æ˜¯ç„¡æ³•æˆåŠŸä½¿ç”¨ã€‚</p><p>åœ¨ä½¿ç”¨ä¸Šï¼Œé‚„æ˜¯éœ€è¦æ‰‹å‹•åŠ å…¥ Port æ‰èƒ½æ­£å¸¸ Clone Repository çš„å…§å®¹ã€‚é€™é‚Šå°±åˆ°æ­¤ç‚ºæ­¢ï¼Œæš«ä¸è™•ç†æ­¤å•é¡Œã€‚</p><p>é‡å°ä½¿ç”¨ä¸åŒçš„ Portï¼Œå®˜æ–¹å»ºè­°çš„è¨­å®šä½œæ³•å¯è¦‹ <a href=#%E9%9D%9E%E9%A0%90%E8%A8%AD-80-port-%E7%9A%84%E5%BB%BA%E8%AD%B0%E4%BD%9C%E6%B3%95>éé è¨­-80-port-çš„å»ºè­°ä½œæ³•</a>ã€‚</p><h2 id=è¨»å†Š-gitlab-runner>è¨»å†Š GitLab-Runner</h2><p>é¦–å…ˆä½¿ç”¨ GitLab-Runner çš„ Docker Imageï¼Œå°‡ Runner çš„æœå‹™æ¶è¨­èµ·ä¾†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Create Volume</span>
</span></span><span style=display:flex><span>docker volume create gitlab-runner-config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å•Ÿç”¨ GitLab-Runner</span>
</span></span><span style=display:flex><span>docker run -d \
</span></span><span style=display:flex><span>  --name gitlab-runner \
</span></span><span style=display:flex><span>  --restart always \
</span></span><span style=display:flex><span>  -v /var/run/docker.sock<span style=color:#960050;background-color:#1e0010>:</span>/var/run/docker.sock \
</span></span><span style=display:flex><span>  -v gitlab-runner-config<span style=color:#960050;background-color:#1e0010>:</span>/etc/gitlab-runner \
</span></span><span style=display:flex><span>  gitlab/gitlab-runner<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>æ¥è‘—ï¼Œå‘ GitLab Server è¨»å†Š Giblab-Runnerï¼Œè®“ GitLab çŸ¥é“æœ‰é‚£äº› Runner å¯ä»¥ä½¿ç”¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># é€²è¡Œ Runner è¨»å†Š</span>
</span></span><span style=display:flex><span>docker exec -it gitlab-runner gitlab-runner register
</span></span></code></pre></div><p>åœ¨è¨»å†Šéç¨‹ä¸­ï¼Œæœƒæœ‰è¨Šæ¯æä¾›ï¼Œè¦æ±‚ä¾åºè¼¸å…¥ <code>GitLab Url</code>ã€<code>Token</code>ã€<code>Runner çš„æè¿°</code>ã€<code>Runner's tags</code>ã€<code>Runner's maintain note</code>ã€<code>Executor</code> ç­‰è³‡è¨Šã€‚</p><p>åœ¨ GitLab çš„ Runner å¯è¨»å†Šç‚ºå…±ç”¨çš„ <code>Shared Runner</code> æˆ–å‚ä¾›å°ˆæ¡ˆæœ¬èº«ä½¿ç”¨çš„ <code>Runner</code>ã€‚</p><p>åœ¨è¨»å†Šå°ˆæ¡ˆæœ¬èº«ä½¿ç”¨çš„ Runner æ™‚ï¼Œæ‰€éœ€çš„ <code>Url</code> èˆ‡ <code>Token</code>ï¼Œå¯ä»¥å¾å°ˆæ¡ˆçš„ <code>Settings > CI/CD</code> çš„ <code>Runners</code> å–å¾—ã€‚</p><p><img src=gitlab_registor_runner.png alt="Runner setting"></p><p>âš ï¸ åœ¨è¨»å†Šéç¨‹ä¸­ï¼Œæœƒç™¼ç”Ÿæœƒç™¼ç”Ÿ <code>connect refuse</code> çš„å•é¡Œã€‚</p><p><img src=runnerj_register_failed.png alt="runner registory fail: connect refuse"></p><p>å¾ä¸Šé¢å¯ä»¥çœ‹åˆ° <code>é€£ç·šåˆ° 127.0.0.1:8080 è¢«æ‹’</code> çš„ç•°å¸¸è¨Šæ¯ï¼Œè‹¥å° docker network æ¦‚å¿µä¸ç†Ÿæ‚‰çš„è©±ï¼Œå¯èƒ½æœƒåœ¨é€™é‚Šå¡ä½ï¼Œç„¡æ³•ç†è§£ï¼Œç‚ºä½•ç„¡æ³•é€£ç·šï¼Ÿ</p><p>ç°¡å–®èªªæ˜ä¸€ä¸‹ï¼Œåœ¨ Docker å…§çš„ Network åˆ†ç‚º <code>bridge</code>ã€<code>overlay</code>ã€<code>ipvlan</code>ã€<code>macvlan</code>ã€<code>none</code> ç­‰é¡å‹ã€‚é è¨­æ˜¯ä½¿ç”¨ <code>brige</code> çš„é¡å‹ã€‚</p><p>ç”¨åœ–ä¾†ç†è§£ç›®å‰çš„ Container çš„ç¶²è·¯æ¶æ§‹ã€‚</p><p><img src=docker_network.png alt=network></p><p>åœ¨äº†è§£ç¶²è·¯æ¶æ§‹å¾Œï¼Œæœ‰å…©ç¨®èª¿æ•´çš„åšæ³•ã€‚åˆ†åˆ¥ç‚ºç¡¬å¹¹å‹èˆ‡æ¨™æº–å‹ã€‚</p><p>ğŸ”² ç¡¬å¹¹å‹ä½œæ³•:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># é¡¯ç¤º GitLab çš„ç¶²è·¯è¨­å®š</span>
</span></span><span style=display:flex><span>docker inspect <span style=color:#f92672>-f</span> <span style=color:#e6db74>&#39;{{json .NetworkSettings.Networks}}&#39;</span> gitlab
</span></span></code></pre></div><p><img src=gitlab_container_networkSetting.png alt="network setting of gitlab container"></p><p>ç™¼ç¾ GitLab container åœ¨ Bridge å…§é…çš„ IP ç‚º <code>172.17.0.2</code>ï¼ŒGateway ç‚º <code>172.17.0.1</code>ï¼Œåœ¨è¨»å†Š Runner æ™‚ï¼Œ<code>GitLab Url</code> ä½ç½®çš„è¨­å®šæ–¹å¼æœ‰å…©ç¨®</p><ul><li>ä½¿ç”¨ IP: å› ç‚º GitLab é è¨­ä½¿ç”¨ 80 Portï¼Œç›´æ¥è¼¸å…¥ <code>http://172.17.0.2</code>ï¼Œå°±å¯ä»¥æˆåŠŸå¾ GitLab-Runner é€£å…¥ GitLabã€‚</li><li>ä½¿ç”¨ Gateway: è¼¸å…¥ <code>http://172.17.0.1:8080/</code>ã€‚ç°¡å–®ä¾†èªªï¼ŒBridge æœƒä¾æ“š Container å»ºç«‹æ™‚çš„è¨­å®šï¼Œå‚³å°è‡³ GitLab Continerã€‚é€™é‚ŠåŸç†æ¯”è¼ƒè¤‡é›œï¼Œå†å¦å¤–èªªæ˜ã€‚</li></ul><p><img src=register_runner_success.png alt="runner registory success"></p><p>æˆåŠŸè¨»å†Šå¾Œï¼Œå†é‡æ–°æ•´ç† <code>Setting > CI/CD</code> çš„é é¢ï¼Œæœƒç™¼ç¾åŸå…ˆ Runner çš„é …ç›®ä¸‹ï¼Œå‡ºç¾æ–¹æ‰æ–°çš„ Runnerã€‚</p><p><img src=gitlab_specific_Runner.png alt="specific runner"></p><p>â˜‘ æ¨™æº–çš„ä½œæ³•(å»ºè­°):</p><p>è‹¥ä½¿ç”¨é è¨­çš„ Bridge ç¶²è·¯ï¼ŒContainer è‹¥è¦èˆ‡å¦ä¸€å€‹ Container å»ºç«‹é€£ç·šï¼Œåªèƒ½ä½¿ç”¨ IP çš„æ–¹å¼ã€‚</p><p><a href=https://docs.docker.com/network/bridge/#use-the-default-bridge-network>å®˜æ–¹æ–‡ä»¶</a>ä¸­ä¹Ÿæåˆ°ï¼Œä½¿ç”¨è‡ªå®šç¾©çš„ Bridge ç¶²è·¯ (User-defined bridge networks) å„ªæ–¼ default bridgeï¼ŒåŒæ™‚æœ‰ä»¥ä¸‹å¹¾é»å¥½è™•ã€‚</p><ul><li>User-defined bridges provide automatic DNS resolution between containers.</li><li>User-defined bridges provide better isolation.</li><li>Containers can be attached and detached from user-defined networks on the fly.</li><li>Each user-defined network creates a configurable bridge.</li><li>Linked containers on the default bridge network share environment variables.</li></ul><p>æ‰€ä»¥ï¼Œæˆ‘å€‘ä¾†å»ºç«‹ GitLab å°ˆç”¨çš„ Bridge ç¶²è·¯å§ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>docker network create --driver bridge gitlab-network
</span></span></code></pre></div><p>è‹¥æ˜¯ Container é‚„æ²’å»ºç«‹ä¹‹å‰ï¼Œå¯åœ¨å»ºç«‹ Container æ™‚ï¼ŒåŠ å…¥åƒæ•¸ <code>--network gitlab-network</code>ã€‚</p><p>ç”±æ–¼å…ˆå‰å·²å»ºç«‹ <code>GitLab</code> èˆ‡ <code>GitLab-Runner</code> å…©å€‹ Containerï¼Œæ‰€ä»¥æ¥ä¸‹ä¾†è¦è®Šæ›´é€™å…©å€‹ Container ä½¿ç”¨çš„ç¶²è·¯è¨­å®šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># åœæ­¢ Contianer</span>
</span></span><span style=display:flex><span>docker stop gitlab, gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åŠ å…¥ gitlab-network ç¶²è·¯</span>
</span></span><span style=display:flex><span>docker network disconnect gitlab-network gitlab
</span></span><span style=display:flex><span>docker network disconnect gitlab-network gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç§»é™¤ bridbe ç¶²è·¯</span>
</span></span><span style=display:flex><span>docker network disconnect bridge gitlab
</span></span><span style=display:flex><span>docker network disconnect bridge gitlab-runner
</span></span></code></pre></div><p>æ­¤æ¬¡å†æª¢è¦–é è¨­ Bridge ç¶²è·¯çš„å…§å®¹ï¼Œå¯ä»¥ç™¼ç¾ GitLab èˆ‡ GitLab-Runner å…©å€‹ Container å·²ä¸åœ¨å…¶ä¸­ã€‚</p><p><img src=default_gridge_network_nouse.png alt="default gridge network"></p><p>è€Œåœ¨ <code>gitlab-network</code> çš„ bridge ç¶²è·¯ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å…©å€‹ Containerã€‚</p><p><img src=user-define-bridge-network.png alt="User-Defined gridge network"></p><p>å†æ¬¡é€²è¡Œ Runner çš„è¨»å†Šæ™‚ï¼Œ<code>GitLab Url</code> å°±å¯ä»¥ä½¿ç”¨ DNS çš„æ–¹å¼æŒ‡åˆ° GitLab Containerã€‚</p><p><img src=runner_register_success_2.png alt="runner registory success"></p><p>âš ï¸ è£œå……ï¼šåœ¨ GitLab-Runner çš„ Container å…§ï¼Œ<code>/etc/hosts</code> å…§å·²å®šç¾© <code>localhost</code>ï¼Œæ‰€ä»¥åœ¨è¨»å†Šæ™‚ä½¿ç”¨ localhost å¿…å®šæœƒå¤±æ•—ã€‚</p><h2 id=éé è¨­-80-port-çš„å»ºè­°ä½œæ³•>éé è¨­ 80 Port çš„å»ºè­°ä½œæ³•</h2><p>ä¸Šé¢èŠ±äº†å¾ˆå¤šåŠŸå¤«åœ¨è™•ç† Docker PortBinding ä¸åŒï¼Œæ‰€é€ æˆçš„å»¶ä¼¸å•é¡Œã€‚å…¶å¯¦å¯ä»¥åƒè€ƒ<a href=https://docs.gitlab.com/ee/install/docker.html#expose-gitlab-on-different-ports>å®˜æ–¹æ–‡ä»¶</a>ï¼Œæ¸›å°‘ <code>Clone</code> æ™‚ï¼Œè·¯å¾‘é€ æˆçš„å•é¡Œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-docker data-lang=docker><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>docker run --detach <span style=color:#ae81ff>\
</span></span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ae81ff></span>  --hostname gitlab.example.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ae81ff></span>  --publish 8929:8929 --publish 2289:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ae81ff></span>  --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ae81ff></span>  --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/config:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/logs:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ae81ff></span>  --volume $GITLAB_HOME/data:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ae81ff></span>  --shm-size 256m <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ae81ff></span>  gitlab/gitlab-ee:latest<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>æœ‰å…©å€‹é‡é»åƒæ•¸ <code>--hostanme</code> èˆ‡ <code>--publish</code>ï¼Œåœ¨ publish çš„ PortBinding æ™‚ï¼Œç›¡å¯èƒ½ä½¿ç”¨ç›¸åŒçš„ Portï¼Œé€™æ¨£å¯ä»¥æ¸›å°‘å¾ˆå¤šéº»ç…©ã€‚</p><p>åœ¨å•Ÿå‹• Container å¾Œï¼Œæ¥è‘—é€²å…¥ Container å…§ï¼Œé€²è¡Œ <code>etc\gitlab\gitlab.rb</code> çš„èª¿æ•´ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åŸ·è¡Œ GitLab&#39;s Container å…§çš„ bashï¼Œä¸¦èˆ‡å…¶äº’å‹•</span>
</span></span><span style=display:flex><span>docker exec -it gitlab /bin/bash
</span></span></code></pre></div><p>é †å¸¶ä¸€æï¼ŒGitLab çš„ Docker Image å»ºç«‹çš„ Containerï¼Œæœªå®‰è£ vimï¼Œè‹¥è¦ä½¿ç”¨ vim é€²è¡Œ <code>gitlab.rb</code> çš„å…§å®¹ä¿®æ”¹ï¼Œéœ€é¡å¤–é€²è¡Œå®‰è£ vimã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rb data-lang=rb><span style=display:flex><span><span style=color:#75715e># For HTTP/HTTPS</span>
</span></span><span style=display:flex><span>external_url <span style=color:#e6db74>&#34;http://gitlab.example.com:8929&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¨­å®š SSH æ‰€ä½¿ç”¨çš„ Port</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;gitlab_shell_ssh_port&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2289</span>
</span></span></code></pre></div><p>å®Œæˆä¿®æ”¹å¾Œï¼Œè¨˜å¾—è¦å¥—ç”¨ä¿®æ”¹å¾Œçš„è¨­å®šã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é‡æ–°å¥—ç”¨ gitlab.rb çš„è¨­å®š</span>
</span></span><span style=display:flex><span>gitlab-ctl reconfigure
</span></span></code></pre></div><h2 id=ä½¿ç”¨-docker-compose-ç›´æ¥åœ¨æœ¬æ©Ÿå»ºç«‹-gitlab-server-èˆ‡-runner>ä½¿ç”¨ Docker-compose ç›´æ¥åœ¨æœ¬æ©Ÿå»ºç«‹ GitLab Server èˆ‡ Runner</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># docker-compose.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.7&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gitlab/gitlab-ce:latest&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#39;localhost&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>gitlab-ce</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>GITLAB_OMNIBUS_CONFIG</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span>        <span style=color:#ae81ff>external_url &#39;http://localhost&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8080:80&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8443:443&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/config:/etc/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/logs:/var/log/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/data:/var/opt/gitlab&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>gitlab</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gitlab-runner</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gitlab/gitlab-runner:alpine</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>gitlab-runner    </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;$GITLAB_HOME/gitlab-runner:/etc/gitlab-runner&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>gitlab</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gitlab</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gitlab-network</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># ä½¿ç”¨ docker-compose.yml å•Ÿå‹• Container</span>
</span></span><span style=display:flex><span>docker-compse -d up
</span></span></code></pre></div><h2 id=é€²è¡Œ-gitlab-ci-æ¸¬è©¦>é€²è¡Œ GitLab CI æ¸¬è©¦</h2><p>æ¥è‘—ï¼Œä¾†æ’°å¯« GitLab CI çš„åŸ·è¡Œè…³æœ¬ã€‚åˆ° <code>CI/CD > Editor</code> å…§é€²è¡Œ <code>.gitlab-ci.yml</code> çš„ç·¨è¼¯ï¼Œæˆ‘å€‘ç›´æ¥ä½¿ç”¨é è¨­ç”¢ç”Ÿçš„å…§å®¹é€²è¡Œæ¸¬è©¦ã€‚</p><p><img src=gitlab_ci_editor.png alt="CD/CD Editor"></p><p>âš ï¸ æ­¤æ™‚æœƒç™¼ç¾ CI å¡ä½ã€‚ä¸€ç›´åœ¨ <code>Pending</code>ï¼Œé€™æ˜¯å› ç‚º <code>.gitlab-ci.yml</code> å…§æœªæŒ‡å®š Runner Tagï¼ŒGitLab CI æ‰¾ä¸åˆ°å¯ä»¥ç”¨çš„ Runnerã€‚</p><p><img src=ci_pending.png alt="CI Pending">
<img src=ci_pending_2.png alt="CI Pending 2"></p><p>æ‰€ä»¥éœ€è¦åˆ° <code>Settings > CI/CD</code> çš„ Runnerï¼Œå°‡è² è²¬ CI çš„ Runner é€²è¡Œçš„è¨­å®šè®Šæ›´ï¼Œå‹¾é¸ <code>Run Untagged Job</code> å³å¯ã€‚</p><p><img src=gitlab_setting_runner_edit.png alt="runner edit"><br><img src=edit_runner_untagged.png alt="runner edit"></p><p>æ¥è‘— Redo ä¹‹å‰çš„ CI Jobï¼Œé‚„æ˜¯ç™¼ç”ŸéŒ¯èª¤ã€‚</p><p><img src=cannot_pull_git.png alt="can&amp;rsquo;t pull git"></p><p>âš ï¸ Runner å›æ‡‰ git çš„è·¯å¾‘ä¸æ­£ç¢ºï¼Œç„¡æ³•é€£ç·šã€‚å› æ­¤ï¼Œéœ€è¦é¡å¤–åœ¨ GitLab-runner çš„ <code>etc\gitlab-runner\config.toml</code> ä¸­ï¼ŒåŠ å…¥åƒæ•¸ <code>clone-url</code>ã€‚</p><p><img src=clone_url.png alt="add clone url"></p><p>èª¿æ•´å®Œæˆå¾Œï¼Œè¨˜å¾—è¦é‡ç½® GitLab-Runnerã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é‡ç½® gitlab-runnerï¼Œå¥—ç”¨è®Šæ›´çš„è¨­å®š</span>
</span></span><span style=display:flex><span>gitlab-runner restart
</span></span></code></pre></div><p>æ¥è‘— Redo ä¹‹å‰çš„ CI Jobï¼ŒæŒçºŒç™¼ç”ŸéŒ¯èª¤ã€‚</p><p><img src=gitlab_job_fail_not_resolve_host.png alt="Can&amp;rsquo;t reslove host"></p><p>æ­¤æ™‚çš„éŒ¯èª¤æ˜¯ç„¡æ³• Runner ç„¡æ³•è§£æ DNSã€‚è‹¥æ˜¯ GitLab-runner çš„ Executor æŒ‡å®š Dockerï¼Œå¿…é ˆå‘ŠçŸ¥ Docker Executor ä½¿ç”¨çš„ç¶²è·¯ã€‚</p><p>åœ¨ <code>etc\gitlab-runner\config.toml</code> çš„ <code>runners.docker</code> åŠ å…¥ <code>network_mode</code> å¾Œï¼Œè¨˜å¾—è¦é‡ç½® GitLab-Runnerã€‚</p><p><img src=add_docker_runner_network.png alt="add netowrk_mode "></p><p>å† Redo ä¹‹å‰çš„ CI Jobï¼Œçµ‚æ–¼æˆåŠŸäº†ã€‚</p><p><img src=gitlab_ci_job_success.png alt="CI success"></p><p>è‹¥ä¸æƒ³è¦é€²åˆ° config.toml é€²è¡Œåƒæ•¸çš„èª¿æ•´ï¼Œä¹Ÿå¯ä»¥åœ¨è¨»å†Š Runner åŠ å…¥åƒæ•¸ <code>--clone-url</code> èˆ‡ <code>--docker-network-mode</code> çš„åƒæ•¸ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># è¨»å†Š GitLab-Runner æ™‚ï¼Œå‚³å…¥åƒæ•¸</span>
</span></span><span style=display:flex><span>docker exec -it gitlab-runner gitlab-runner register \
</span></span><span style=display:flex><span>  --clone-url [gitlab-host] \
</span></span><span style=display:flex><span>  --executor docker \
</span></span><span style=display:flex><span>  --docker-network-mode [network-name]
</span></span></code></pre></div><h2 id=è£œå……è³‡æ–™>è£œå……è³‡æ–™</h2><h3 id=å»¶ä¼¸é–±è®€>å»¶ä¼¸é–±è®€</h3><ul><li>è‰¦é•·ï¼Œä½ æœ‰äº‹å—ï¼Ÿ, <a href=https://chengweichen.com/2021/03/gitlab-ci-executor.html>GitLab CI ä¹‹ Runner çš„ Executor è©²å¦‚ä½•é¸æ“‡ï¼Ÿ</a></li><li>datawookie, <a href=https://datawookie.dev/blog/2021/03/install-gitlab-runner-with-docker/>Install GitLab Runner with Docker</a></li><li>SALMON&rsquo;S BLOG, <a href=https://blog.salmon.tw/2018/05/08/%E8%A8%BB%E5%86%8A%20GitLab%20Runner/>è¨»å†Š GitLab Runner</a></li><li>Rick&rsquo;s Blog, <a href=https://www.rickjiang.dev/blog/gitlab-and-gitlab-runner-with-docker>åˆ©ç”¨ Docker å»ºç½® GitLab + GitLab Runner</a></li><li>Patrycjusz Czerniga, <a href=https://www.czerniga.it/2021/11/14/how-to-install-gitlab-using-docker-compose/>How to install GitLab using Docker Compose?</a></li><li>MIRANTIS, <a href=https://docs.mirantis.com/containers/v3.0/dockeree-ref-arch/networking/scalable-container-networks.html>Exploring Scalable, Portable Docker Swarm Container Networks</a></li></ul><h3 id=åƒè€ƒè³‡æ–™>åƒè€ƒè³‡æ–™</h3><ul><li>Stackoverflow, <a href=https://stackoverflow.com/questions/53370840/sthis-job-is-stuck-because-the-project-doesnt-have-any-runners-online-assigned>This job is stuck, because the project doesn&rsquo;t have any runners online assigned to it. Go to Runners page</a></li><li>Stackoverflow, <a href=https://stackoverflow.com/questions/50325932/gitlab-runner-docker-could-not-resolve-host>GitLab runner docker Could not resolve host</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/gitlab/ rel=tag>GitLab</a></ul></div></footer><div><p>æ–‡ç« å…§å®¹å‡ç‚ºå€‹äººå­¸ç¿’è¨˜éŒ„ã€å¿ƒå¾—èˆ‡èªçŸ¥ï¼Œè‹¥ä»»ä½•è¬¬èª¤æˆ–å»ºè­°ï¼Œæ­¡è¿ç›´æ¥ç•™è¨€è¨è«–ï¼Œä¸€åŒæˆé•·ã€‚</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feanlee.github.io%2fpost%2fdevops%2fgitlab_ci_same_host%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/series/build_automated_deploy/container_intro/ rel=prev><span class=pager__subtitle>Â«&#8201;Previous</span><p class=pager__title>éƒ¨ç½²æ–°å¢ƒç•Œ - ä½¿ç”¨ Container ç°¡åŒ–æµç¨‹</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/devops/gitlab_ci_network/ rel=next><span class=pager__subtitle>Next&#8201;Â»</span><p class=pager__title>GitLab CI å¯¦ä½œè¨˜éŒ„(2) - Gitlab CI çš„ç§æœ‰ç’°å¢ƒå»ºç½®</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 ä¼Šæ©è»Ÿé«”æŠ€è¡“å­¸ç¿’èˆ‡åˆ†äº«.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>