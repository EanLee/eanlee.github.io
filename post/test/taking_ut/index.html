<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>淺談單元測試的撰寫 - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="分享寫單元測試過程中，經常被人詢問議題，或是自己遇到困惑點"><meta property="og:title" content="淺談單元測試的撰寫"><meta property="og:description" content="分享寫單元測試過程中，經常被人詢問議題，或是自己遇到困惑點"><meta property="og:type" content="article"><meta property="og:url" content="https://eanlee.github.io/post/test/taking_ut/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-04T06:22:43+00:00"><meta property="article:modified_time" content="2022-08-04T12:30:07+00:00"><meta itemprop=name content="淺談單元測試的撰寫"><meta itemprop=description content="分享寫單元測試過程中，經常被人詢問議題，或是自己遇到困惑點"><meta itemprop=datePublished content="2022-08-04T06:22:43+00:00"><meta itemprop=dateModified content="2022-08-04T12:30:07+00:00"><meta itemprop=wordCount content="467"><meta itemprop=keywords content="單元測試,"><meta name=twitter:card content="summary"><meta name=twitter:title content="淺談單元測試的撰寫"><meta name=twitter:description content="分享寫單元測試過程中，經常被人詢問議題，或是自己遇到困惑點"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>淺談單元測試的撰寫</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-08-04T06:22:43Z>2022-08-04</time>
<time class=meta__text datetime=2022-08-04T12:30:07Z>(Last Modified: 2022-08-04)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/%E6%B8%AC%E8%A9%A6/ rel=category>測試</a>, <a class=meta__link href=/categories/%E9%96%8B%E7%99%BC%E9%9B%9C%E8%AB%87/ rel=category>開發雜談</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#單元測試的重點>單元測試的重點</a></li><li><a href=#沒有測試保護的程式要如何下手>沒有測試保護的程式，要如何下手？</a></li><li><a href=#需注入眾多相依物件的類別是否需要-mock-所有的依賴類別>需注入眾多相依物件的類別，是否需要 Mock 所有的依賴類別？</a><ul><li><a href=#兩種測試案例的撰寫風格>兩種測試案例的撰寫風格</a></li><li><a href=#根本的解法>根本的解法</a></li></ul></li><li><a href=#延伸閱讀>延伸閱讀</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>近年來，在業界各位前輩的推展下，越來越多人知道單元測試，並且開始撰寫單元測試。</p><p>但有些撰寫單元測試過程中，遇到有些經常被人詢問議題，或是自己撰寫過程所遇到困惑點，在這分享個人的觀點。</p><ul><li>運用單元測試，讓工具可以自動化一再反覆驗證核心業務邏輯或是高風險的邏輯，以確保業務邏輯或規則的正確性。</li><li>對於沒有測試保護的程式，使用已知的使用情境案例，從修改部份進行最大範圍的框選，運用粗顆粒的測試案例，讓修改部份，有個基本的保護。</li><li>對於需要注入眾多物件的類別，應考量是否需要進行功能切分。減少單元測試的複雜性，提升程式的維護性。</li></ul><h2 id=單元測試的重點>單元測試的重點</h2><p>在單元測試，有時我們會去關心測試覆蓋率 (Code Coverage) 的數值，但是是否需要追求 100% 的 Code coverage 嗎？</p><p>個人認為不需要，依據 80/20 法則，可能程式碼內的 20% 的部份，乘載了 80% 的業務行為。這 20% 的程式碼是系統的核心關鍵業務，換個角度來看，這 20% 的程式碼，承擔了 80% 的風險。</p><p>回到測試的本質，是為了讓核心業務邏輯或是高風險的邏輯，可以一再被的反覆驗證。所以運用單元測試，讓開發工具可以自動化針對程式內的業務邏輯，進行驗證，以確保業務邏輯或規則的正確性。</p><p>以電商系統而言，可能購物車金額計算與結帳交易的部份，只佔整個系統不到 20%，但這部份卻是最重要的業務核心。針對這個部份進行單元測試的撰寫，以最小的範圍的測試保護，得到最大的成效。</p><p>高變動性的操作邏輯或是防保是否需要進行單元測試，個人認為不需要，因為變動過多，會導致額外維護單元測試的工作。可考量右移至整合測試或 End-To-End 測試的階段。</p><p>順帶一提，若防保的檢查機制與業務邏輯相關的話，就必需列入單元測試的考量範圍內。</p><h2 id=沒有測試保護的程式要如何下手>沒有測試保護的程式，要如何下手？</h2><p>當接手 Legacy Code 時，可能會發現沒有任何測試保護，造成程式調整後，開發人員自己也無法百分百保証，原先的功能都能正確動作。就可能出現改 A 壞 B 的情況發生。</p><p>個人認為可以先從要修改部份，最大範圍的進行框選，使用已知的使用情境案例，撰寫測試，進行保護。無需執著於單元測試這個名稱。</p><p>這些測試案例的測試維度，基本上顆粒極大，可能很包含很多很雜的識責。但沒有關係，重點在於有個基本的保護。</p><p>後續隨著功能修改與重構，也會增加對應的測試案例，這些測試案例的顆粒度會更細，更針對應特定業務邏輯。</p><p>隨著案例的增加，可能在某一天，原本粗顆粒的測試案例的業務邏輯，已完全被其他測試案例的 Cover，這時團隊的開發人員，可以討論原本粗顆粒的測試案例是否保留或是移除。</p><p>順帶一提，在補上測試案例時，可能會與 Refactoring 配合交互進行，所以調整的步伐要盡可能的小步。</p><h2 id=需注入眾多相依物件的類別是否需要-mock-所有的依賴類別>需注入眾多相依物件的類別，是否需要 Mock 所有的依賴類別？</h2><p>已經存在一個運行數年的類別 ShoppingCartService，也已經存在了多組測試案例保護。</p><p>如今，購物車需要支援優惠活動，而活動的折扣計算，依據活動的扣折規則與會員等級的不同，計算出不同的扣折金額。</p><p>此時，因為這個扣折金額與購物車相關，所以我們可能會下意識，將取得折扣金額的方法 <code>GetDiscount</code>，放入 ShoppingCartService 之中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-C# data-lang=C#><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e>/// 購物車</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#75715e>/// &lt;/Summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShoppingCartService</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>void</span> ShoppingCartService(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        IProductionService productionSerice,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        IProductionSkuService prouctionSkuService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        IMemberService memberService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        IRateLimitService rateLimitService,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        IPromotionService promotionService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        IShoppingCartRepository shoppingCartRepository,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        ...)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#75715e>// ....</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#75715e>/// 計算購物車內的金額</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Calcualate(ShoppingCartEntity shoppingCart)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>       <span style=color:#75715e>// 使用 IProductionService, IProductionSkuService, IMemberService, etc.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#75715e>/// 取得購物車的折扣金額</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>decimal</span> GetDiscount(ShoppingCartEntity shoppingCart)
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#75715e>// 只使用 IMemberService, IPromotionService 進行購物車折扣後的計算</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    } 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> Verify(ShoppingCartEntity shoppingCart)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#75715e>// 使用 IProductionService, IProductionSkuService</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>}
</span></span></code></pre></div><p>若要針對全新的方法 <code>GetDiscount</code> 進行測試的補足，在撰寫的單元測試時，可能會出現兩種撰寫風格。這兩種風格沒有好壞，只要團隊成員成員有共識即可。</p><h3 id=兩種測試案例的撰寫風格>兩種測試案例的撰寫風格</h3><p>▶ <strong>直接在現有的單元測試類別中，加入新的測試案例。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-C# data-lang=C#><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShoppingCartServiceTest</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    IProductionService _productionSerice;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    IProductionSkuService _prouctionSkuService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    IMemberService _memberService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    IRateLimitService _rateLimitService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    IShoppingCartRepository _shoppingCartRepository;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    IPromotionService _promotionService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>public</span> ShoppingCartServiceTest()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>       <span style=color:#66d9ef>this</span>._productionSerice = Substitute.For&lt;IProductionService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>       <span style=color:#66d9ef>this</span>._prouctionSkuService = Substitute.For&lt;IProductionSkuService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>       <span style=color:#66d9ef>this</span>._memberService = Substitute.For&lt;IMemberService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>       <span style=color:#66d9ef>this</span>._rateLimitService = Substitute.For&lt;IRateLimitService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>       <span style=color:#66d9ef>this</span>._shoppingCartRepository = Substitute.For&lt;IShoppingCartRepository&gt;();
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>       <span style=color:#66d9ef>this</span>._promotionService = Substitute.For&lt;IPromotionService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#66d9ef>public</span> IShoppingCartService CreateShoppingCartService()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#66d9ef>var</span> service = <span style=color:#66d9ef>new</span> ShoppingCartService(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#66d9ef>this</span>._productionSerice,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#66d9ef>this</span>._prouctionSkuService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#66d9ef>this</span>._memberService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#66d9ef>this</span>._rateLimitService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#66d9ef>this</span>._promotionService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#66d9ef>this</span>._shoppingCartRepository);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#66d9ef>return</span> service;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    }
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-C# data-lang=C#><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">312</span><span><span style=color:#a6e22e>    [Fact]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">313</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> NewTestCase()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">314</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">315</span><span>        <span style=color:#66d9ef>var</span> service = <span style=color:#66d9ef>this</span>.CreateShoppingCartService();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">316</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">317</span><span>        <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">318</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">319</span><span>}
</span></span></code></pre></div><p>假若該測試類別，已經把初始化 ShoppingCartService 抽為一個方法 <code>CreateShoppingCartService</code>。</p><p>直接使用現有的單元測試類別，並加其中直接加入測試案例的好處。</p><ul><li>無需再另外 Mock 其他依賴的類別</li><li>與 ShoppingCartService 相關的測試案例，都集中在同一地方。</li></ul><p>但也有比較需要額外注意的地方</p><ul><li>測試類別內的測試案例過多過雜，要找到特定案例的時間較長。</li><li>需 Mock 所有相依的物件，即使於與此次測試案例無關，無法在測試案例中直接確認，與案例相關的物件。</li><li>重覆使用的 Mock 物件，若未注意設定或使用方式，可能會出現非預期的問題。</li></ul><p>▶ <strong>另開一個新的測試類別，專門進行折扣的測試案例。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-C# data-lang=C#><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShoppingCartDiscountTest</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    IMemberService _memberService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    IPromotionService _promotionService;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>public</span> ShoppingCartDiscountTest()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>       <span style=color:#66d9ef>this</span>._memberService = Substitute.For&lt;IMemberService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>       <span style=color:#66d9ef>this</span>._promotionService = Substitute.For&lt;IPromotionService&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#a6e22e>    [Fact]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> NewTestCase()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#66d9ef>var</span> service = <span style=color:#66d9ef>new</span> ShoppingCartService(
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#66d9ef>this</span>._memberService,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#66d9ef>this</span>._promotionService,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            <span style=color:#66d9ef>null</span>); 
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span></code></pre></div><p>直接將此次增加的功能，額外建立新的測試類別的好處。</p><ul><li>測試類別與案例職責相近，而且測試類別內的案例較少。</li><li>可以直接確認案例與相依的物件。</li></ul><p>但也有較不好，需額外注意的地方。</p><ul><li>測試案例會散於各處，造成案例的破碎化。</li><li>在建立待測試類別時，可能會傳入一堆 <code>null</code> 的參數。如上方程式碼反白處。</li></ul><h3 id=根本的解法>根本的解法</h3><p>其實會發生上述的的情況，最主要的問題出在類別本身負責的職責過大或過於複雜，造成需要依賴眾多的其他類別，才能完成工作。</p><p>但有趣的是，雖然類別建立時，注入眾多相依的物件，但某些方法僅用到一兩個相依物件。對其他未被使用的物件而言，是種浪費。</p><p>尤其是大量調用上述情境的方法時，資源的浪費會變的額外的明顥。</p><p>別忘了，所有類別的建立出物件，都是需要消耗資料與建置時間的，就算時間再短，但只要這個類別被大量使用時，無効的浪費就會變的很明顯。</p><table><thead><tr><th style=text-align:right>請求量</th><th style=text-align:right>IPromotionService 物件建立的累積耗時</th><th style=text-align:right>所有物件建立的累積耗時</th><th style=text-align:right>物件建立浪費耗時</th></tr></thead><tbody><tr><td style=text-align:right>1</td><td style=text-align:right>7 ms</td><td style=text-align:right>85 ms</td><td style=text-align:right>78 ms</td></tr><tr><td style=text-align:right>10</td><td style=text-align:right>70 ms</td><td style=text-align:right>850 ms</td><td style=text-align:right>780 ms</td></tr><tr><td style=text-align:right>100</td><td style=text-align:right>700 ms</td><td style=text-align:right>8500 ms</td><td style=text-align:right>7800 ms</td></tr><tr><td style=text-align:right>1000</td><td style=text-align:right>7000 ms</td><td style=text-align:right>85000 ms</td><td style=text-align:right>78000 ms</td></tr></tbody></table><p>這就是 Code smell 中提到的 Large Class，為此真正應該做的是進行類別層次的重構，依職責或業務行為，再進一步細切。在提升程式的維護性的同時，也間接的提升系統的效能。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e>/// 計算折扣</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#75715e>/// &lt;/Summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CalculateDiscountService</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>void</span> CalculateDiscountService(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        IMemberService memberService,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        IPromotionService promotionService)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#75715e>// ....</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#75715e>/// 取得購物車的折扣金額</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>decimal</span> GetDiscount(ShoppingCartEntity shoppingCart)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#75715e>// 只使用 IMemberService, IPromotionService 進行購物車折扣後的計算</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><h2 id=延伸閱讀>延伸閱讀</h2><ul><li><a href=https://mp.weixin.qq.com/s/6C-t1QhgPI6zwr4gx_uGAg>如何避免單元測試的陷阱？</a></li><li><a href=https://zh.wikipedia.org/zh-tw/%E4%BB%A3%E7%A0%81%E5%BC%82%E5%91%B3>Code smell</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6/ rel=tag>單元測試</a></ul></div></footer><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feanlee.github.io%2fpost%2ftest%2ftaking_ut%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/series/build_automated_deploy/yaml/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>淺談 YAML 格式</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/series/build_automated_deploy/container_intro/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>部署新境界 - 使用 Container 簡化流程</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>