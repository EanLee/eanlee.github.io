<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Docker | 縮網址服務實作記錄(2) - 基於 Docker 的 Let's Encrypt 申請與設定 - 伊恩的開發狂想</title>
<script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="本文介紹如何在 Docker 環境中，使用 Let's Encrypt 與 Certbot 申請免費 SSL/TLS 憑證，並設定 Nginx 支持 HTTPS。主要內容包括直接在 Ubuntu 主機使用 Certbot 配合 volume 掛載申請憑證、使用 Certbot 官方 Docker Image 的申請流程。適合需要在 Docker 容器中設定 HTTPS 的網站管理員或開發者參考。"><meta property="og:title" content="Docker | 縮網址服務實作記錄(2) - 基於 Docker 的 Let's Encrypt 申請與設定"><meta property="og:description" content="本文介紹如何在 Docker 環境中，使用 Let's Encrypt 與 Certbot 申請免費 SSL/TLS 憑證，並設定 Nginx 支持 HTTPS。主要內容包括直接在 Ubuntu 主機使用 Certbot 配合 volume 掛載申請憑證、使用 Certbot 官方 Docker Image 的申請流程。適合需要在 Docker 容器中設定 HTTPS 的網站管理員或開發者參考。"><meta property="og:type" content="article"><meta property="og:url" content="https://eandev.com/post/series/side-project/shorten-2-lets-encrypt-setting/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-11-17T16:38:06+08:00"><meta property="article:modified_time" content="2023-11-17T17:42:01+08:00"><meta itemprop=name content="Docker | 縮網址服務實作記錄(2) - 基於 Docker 的 Let's Encrypt 申請與設定"><meta itemprop=description content="本文介紹如何在 Docker 環境中，使用 Let's Encrypt 與 Certbot 申請免費 SSL/TLS 憑證，並設定 Nginx 支持 HTTPS。主要內容包括直接在 Ubuntu 主機使用 Certbot 配合 volume 掛載申請憑證、使用 Certbot 官方 Docker Image 的申請流程。適合需要在 Docker 容器中設定 HTTPS 的網站管理員或開發者參考。"><meta itemprop=datePublished content="2023-11-17T16:38:06+08:00"><meta itemprop=dateModified content="2023-11-17T17:42:01+08:00"><meta itemprop=wordCount content="1045"><meta itemprop=keywords content="Docker,Nginx,Traefik,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker | 縮網址服務實作記錄(2) - 基於 Docker 的 Let's Encrypt 申請與設定"><meta name=twitter:description content="本文介紹如何在 Docker 環境中，使用 Let's Encrypt 與 Certbot 申請免費 SSL/TLS 憑證，並設定 Nginx 支持 HTTPS。主要內容包括直接在 Ubuntu 主機使用 Certbot 配合 volume 掛載申請憑證、使用 Certbot 官方 Docker Image 的申請流程。適合需要在 Docker 容器中設定 HTTPS 的網站管理員或開發者參考。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=/css/style.min.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img alt=logo src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Docker | 縮網址服務實作記錄(2) - 基於 Docker 的 Let's Encrypt 申請與設定</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-11-17T16:38:06+08:00>2023-11-17</time>
<time class=meta__text datetime=2023-11-17T17:42:01+08:00>(Last Modified: 2023-11-17)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/%E6%9E%B6%E6%A7%8B/ rel=category>架構</a>, <a class=meta__link href=/categories/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/ rel=category>軟體開發</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#基於-nginx-的憑證申請與設定>基於 NGINX 的憑證申請與設定</a><ul><li><a href=#1-使用-certbot---webroot-配合-mount-來設定-ssltls-憑證>1. 使用 <code>Certbot --webroot</code> 配合 Mount 來設定 SSL/TLS 憑證</a></li><li><a href=#2-使用-certbox-官方的-docker-image>2. 使用 Certbox 官方的 Docker Image</a></li></ul></li><li><a href=#補充資料>補充資料</a></li></ul></nav></div></div><div class="content post__content clearfix"><blockquote><p>縮網址服務為 <a href=https://url-ins.com/shorten/>https://url-ins.com/shorten/</a> ，有任何想法或回饋，可以在 <a href=https://www.surveycake.com/s/wgveX>SurveyCake</a> 留下寶貴的意見。(為了維持主機的維運，在頁面內放入 Google Adsense 廣告。)</p></blockquote><p>在 <a href=../../../Publish/Series/side-project/%E7%B8%AE%E7%B6%B2%E5%9D%80%E6%9C%8D%E5%8B%99%E5%AF%A6%E4%BD%9C%E8%A8%98%E9%8C%84(1)%20-%20%E5%9F%BA%E6%96%BC%20Docker%20%E5%AE%B9%E5%99%A8%E6%8A%80%E8%A1%93%E7%9A%84%E7%B6%B2%E7%AB%99%E6%9C%8D%E5%8B%99%E6%9E%B6%E6%A7%8B%E5%AF%A6%E8%B8%90.md>縮網址服務實作記錄(1) - 基於 Docker 容器技術的網站服務架構實踐</a> 中，已經完成基本服務的建立。</p><p>為了確保服務站台的可靠性與提升 SEO。接下來，就是要為服務站台增加 HTTPS 的 SSL/TLS 憑證保護。</p><p><code>Let's Encrypt</code> 提供的免費的 SSL/TLS 憑證，雖然說有 3 個月的時間限制。但只要配合 <code>Certbot</code> 來協助 SSL/TLS 憑證申請與更新，就可以為站台提供更可靠的保護。</p><p>有趣的是，在研究與尋找如何進行 Ngnix 與 Let&rsquo;s Encrypt 設定的過程，無意中發現 <a href=https://traefik.io/><code>Traefik</code></a>。一套高度支援 Dockr ，與 Ngnix 相似的反向代理工具(Reverse Proxy)，後續有機會使用，也會隨手記錄操作筆記。</p><blockquote><p>在本篇文章中，主要是在討論以下的項目</p><ul><li>如何為 Container 內的 NGINX 進行 Let&rsquo;s Encrypt 的設定。</li><li>使用 Certbot 官方提供的 docker Image 來申請 SSL/TLS 憑證。</li><li>Docker 的 Volume 的用法。</li></ul></blockquote><p>在完成服務的架設後，已經可以使用 HTTP ，經由 Domain 連線到服務站台。再進一步，我們要藉由 SSL/TLS 憑證來提升服務站台的可靠性與安全性。</p><p>當然，我們可以選擇收費的憑證頒發機構(Certificate Authority, CA)，例如 TWCA、Sectigo、Certum 等等。在成本的考量下，選擇使用 <a href=https://letsencrypt.org/zh-tw/>Let&rsquo;s Encrypt</a> 提供的 SSL/TLS 憑證。</p><p>在 Let&rsquo;s Encrypt 的<a href=https://letsencrypt.org/zh-tw/docs/client-options/>官方文件</a>，也推薦使用 <code>Certbot</code> 來協助取得與安裝憑證。若是不符合需求，也有列出其他類型的工具。</p><p>額外補充，只要有實作 <code>ACME</code> (<a href=https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment>Automatic Certificate Management Environment</a>) 協定的工具，都可以跟 Let&rsquo;s Encrypt 申請 SSL/TLS 憑證。</p><p>ACME 的驗證方式，可以進一步查看 Let&rsquo;s Encrypt 提供的 <a href=https://letsencrypt.org/zh-tw/docs/challenge-types/>ACME 驗證方式</a> 說明。</p><p>當 Nginx 直接安裝在 Ubuntu 主機，可以參考<a href=https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/> NGINX 官方 Blog 說明</a>，直接依據下列步驟，進行 Certbot 的安裝與 SSL/TLS 憑證的申請。</p><p>另外，由於 Certbot 已經整合 NGNX，可以使用 <code>certbot --nginx</code> 指令，自動更新 Nginx 組態，請求證書。也可以加上 <code>certonly</code> 參數，讓 certbot 只是單純申請 SSL/TLS 憑證，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 安裝 Certbot</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install certbot
</span></span><span style=display:flex><span>sudo apt-get install python3-certbot-nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用 Certbot 自動進行 NGINX 設定</span>
</span></span><span style=display:flex><span>sudo certbot --nginx -d example.com -d www.example.com
</span></span></code></pre></div><p>certbot 跟 Let&rsquo;s Encrypt 申請的 SSL/TLS 憑證，會存放在 <code>/etc/letsencrypt/live/{網域}</code>。</p><p>但是&mldr;</p><p>在將 NGINX 與靜態網站打包為 Docker Image 的前提下，若是在 Container 進行上述的設定，當更新 Docker Image 的版本時，會再建立一組新的 Container。此時需要再重新進行一次設定。</p><p>在接下來，我會記錄使用 Docker Mount/Volume 機制來保存 SSL/TLS 憑證，或是直接使用 Certbot 類似，但已經被包為 Docker Image 的工具，來協助進行設定。</p><h2 id=基於-nginx-的憑證申請與設定>基於 NGINX 的憑證申請與設定</h2><h3 id=1-使用-certbot---webroot-配合-mount-來設定-ssltls-憑證>1. 使用 <code>Certbot --webroot</code> 配合 Mount 來設定 SSL/TLS 憑證</h3><p>首先，在 Ubuntu 主機安裝 certbot 套件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 安裝 Certbot</span>
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install certbot
</span></span><span style=display:flex><span>sudo apt-get install python3-certbot-nginx
</span></span></code></pre></div><p>使用 <code>--webroot</code> 進行 Let&rsquo;s Encrypt 憑證申請，需要指定網站的根目錄。</p><p>為此，需要調整 <code>docker-compose.yaml</code> 與 <code>nginx.conf</code> 兩個部份。</p><ol><li>調整 docker-compose.yaml 檔內 <code>volumes</code> 的設定, 增加 <code>certbot --webroot</code> 使用的資料夾與 Container 內的目錄對應。</li></ol><p>雖然我們是用 <code>--webroot</code> 的方法，但在 docker-compose.yml 千萬不要直接指定站台根目錄。這會導制站台直接出現 404 錯誤。</p><p>我們建立了一個 <code>letsencrypt-site</code> 的資料夾，以便 Certbot 存放 Let&rsquo;s Encrypt 驗證用的資料檔案。並讓它對應到 Container 內的 <code>/user/share/nginx/html/acme</code>，</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.gitlab.com/url-insight/url-insight/web:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./nginx.conf:/etc/nginx/nginx.conf:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./letsencrypt-site:/usr/share/nginx/html/acme</span> <span style=color:#75715e># --webroot 使用</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      -  <span style=color:#ae81ff>gateway-web</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><ol start=2><li>設定 <code>nginx.conf</code>，讓 <code>/.well-known/acme-challenge</code> 可以指向 Container 內，存放 Let&rsquo;s Encrypt 驗證資料的檔案目錄。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx.conf data-lang=nginx.conf><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>url-ins.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>/.well-known/acme-challenge</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>allow</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>root</span> <span style=color:#e6db74>/usr/share/nginx/html/acme</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/usr/share/nginx/html</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再完成上述的兩個設定後，就可以使用 <code>certbot certonly --webroot</code> 來申請憑證。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 使用 --webroot 的方式</span>
</span></span><span style=display:flex><span>sudo certbot certonly --webroot -w ./letsencrypt-site -d url-ins.com
</span></span></code></pre></div><p><figure><center><img src=images/certbot-certonly-webroot.png alt="certbot certonly &amp;ndash;webroot"><figcaption>certbot certonly &amp;ndash;webroot</figcaption></center></figure></p><p>此時，<code>fullchain.pem</code> 與 <code>privkey.pem</code> 是存放在 Ubuntu 主機的 <code>/etc/letsencrypt/live</code> 目錄下。</p><h4 id=將-ssltls-憑證掛載到-container>將 SSL/TLS 憑證掛載到 Container</h4><p>接下來，就是進行 HTTPS 的 SSL/TLS 憑證設定了。</p><p>為了讓 Container 可以使用剛剛申請的憑證，就必須將憑證所在的資訊夾，掛載到 Container 中。</p><p>有兩種作法可以選擇。</p><ul><li>直接將 <code>/etc/letsencrypt/live</code> 目錄掛載到 Container 。</li><li>將憑證先放到 <code>volume</code> 之中，再把掛載 volume 到 Container。</li></ul><h5 id=直接掛載-etcletsencryptlive-內-ssltls-憑證>直接掛載 <code>/etc/letsencrypt/live</code> 內 SSL/TLS 憑證。</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.gitlab.com/url-insight/url-insight/web:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./nginx.conf:/etc/nginx/nginx.conf:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./letsencrypt-site:/usr/share/nginx/html/acme</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/etc/letsencrypt:/etc/letsencrypt</span> <span style=color:#75715e># 直接掛載 for Let&#39;s Encrypt certificates</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      -  <span style=color:#ae81ff>gateway-web</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h5 id=將-ssltls-憑證放到-docker-volume-後再掛載>將 SSL/TLS 憑證放到 Docker Volume 後再掛載</h5><ul><li>增加 Docker Volume 來存放 certbot 順利取回的 SSL/TLS 憑證。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 建立 Docker Volume</span>
</span></span><span style=display:flex><span>sudo docker volume create <span style=color:#f92672>{</span>volume_name<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>接著把 SSL/TLS 憑證放到 volume 之中。</p><p>此時，我們需要先掛載 volume，才能把 SSL/TLS 憑證放到 volume。可以直接把 volume 掛到 <code>docker-compose.yml</code> 後，進行複制 SSL/TLS 憑證的動作。</p><p>不過，為了方便理解，使用 busybox 掛載剛剛建立出來的 volume。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 建立 Volume</span>
</span></span><span style=display:flex><span>sudo docker volume create letsencrypt-certs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 掛載 volume 到 busybox 內</span>
</span></span><span style=display:flex><span>sudo docker run -v letsencrypt-certs:/mnt --name test-busybox busybox
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 複製 /etc/letsencrypt/ 目錄到 busybox Container 的根目錄</span>
</span></span><span style=display:flex><span>sudo docker cp /etc/letsencrypt test-busybox:/mnt
</span></span></code></pre></div><p>簡單說明上述的指令。</p><ul><li>使用 <code>docker volume create</code> 來建立一個空的 Docker volume。</li><li>在 <code>docker run</code> 時，使用 <code>-v</code> 來掛載 Docker volume，並宣告建立出來的 Container name 為 testbusybox</li><li>最後，使用 <code>docker cp</code> 來進行資料夾的複製。</li></ul><p><figure><center><img src=images/docker-cp-letsencrypt-folder.png alt="複製 /etc/letsencrypt 內的資訊"><figcaption>複製 /etc/letsencrypt 內的資訊</figcaption></center></figure></p><p>當然，如果要確認 volume 是否有資料，可以再建一個臨時 Container 來進行查看。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker run -it --rm -v letsencrypt-certs:/mnt busybox
</span></span></code></pre></div><p><figure><center><img src=images/verify-docker-volume.png alt="建立一個臨時 Container 來確認 volume 內容"><figcaption>建立一個臨時 Container 來確認 volume 內容</figcaption></center></figure></p><p>再完成將 <code>*.pem</code> 複製到 volume 的動作後，就是把 volume 掛載到 NGINX 所在的 Container 中。</p><p>調整後的 <code>docker-compose.yml</code> 如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.gitlab.com/url-insight/url-insight/web:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./nginx.conf:/etc/nginx/nginx.conf:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./letsencrypt-site:/usr/share/nginx/html/acme</span> <span style=color:#75715e># --webroot 使用</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>letsencrypt-certs:/etc/letsencryptexit</span> <span style=color:#75715e># for Let&#39;s Encrypt certificates</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      -  <span style=color:#ae81ff>gateway-web</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>	<span style=color:#f92672>letsencrypt-certs</span>: <span style=color:#75715e># Define the volume for Let&#39;s Encrypt certificates</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h4 id=進行-nginxconf-的-https-設定>進行 <code>nginx.conf</code> 的 HTTPS 設定</h4><p>在完成 SSL/TLS 憑證申請後，接下來就是進行 <code>nginx.conf</code> 的調整，加入 443 的 HTTPS 設定。並將 HTTP 的請求，永久轉址到 HTTPS。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx.conf data-lang=nginx.conf><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span> <span style=color:#f92672>server{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>url-ins.com</span> <span style=color:#e6db74>www.url-ins.com</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_tokens</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>default_server</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:443</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>url-ins.com</span> <span style=color:#e6db74>www.url-ins.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_protocols</span>   <span style=color:#e6db74>TLSv1.2</span> <span style=color:#e6db74>TLSv1.3</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/letsencrypt/live/url-ins.com/fullchain.pem</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/letsencrypt/live/url-ins.com/privkey.pem</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在完成設定後，別忘了讓 NGINX 重新載入 <code>nginx.conf</code> 的設定。</p><h3 id=2-使用-certbox-官方的-docker-image>2. 使用 Certbox 官方的 Docker Image</h3><p>若是不想要在 Ubuntu 主機內，安裝 <code>certbot</code>，也可以選擇使用 Docker Hub 的 <a href=https://hub.docker.com/r/certbot/certbot/>certbot/certbot</a> 來協助申請 SSL/TLS 憑證。</p><p>在 Certbot 的官方說明文件 <a href=https://eff-certbot.readthedocs.io/en/latest/install.html#running-with-docker>Get Certbot — running-with-docker</a> 也有詳細的操作說明。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker run -it --rm --name certbot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -v <span style=color:#e6db74>&#34;/etc/letsencrypt:/etc/letsencrypt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -v <span style=color:#e6db74>&#34;/var/lib/letsencrypt:/var/lib/letsencrypt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            certbot/certbot certonly
</span></span></code></pre></div><p>簡單說明一下上述的指令意思。</p><ul><li>使用 <code>certbot/certbot</code> 的 Docker Image，建立一個用完就刪除的 Container。</li><li>啟動 Container 時，同時傳入 <code>certonly</code> 的參數。</li><li>掛載 <code>/etc/letsencrypt</code> 與 <code>/var/lib/letsencrypt</code> 對應的資料夾。</li></ul><p><code>/var/lib/letsencrypt</code> 用於存放 <code>.well-known/acme-challenge</code> 的所有 HTTP 請求，而 <code>/etc/letsencrypt</code> 則是存放 Let&rsquo;s Encrypt 發放的 SSL/TLS 憑證。</p><p>在 <a href=https://mindsers.blog/en/post/https-using-nginx-certbot-docker/>How to handle HTTPS using Nginx, Let&rsquo;s encrypt and Docker - Mindsers Blog</a> 這篇，作者直接使用 docker compose 來完成 certbox 與 nginx 的整合。內容寫的還滿清楚的，值得一看。</p><p>不過，因為我個人想要維持 dokcer-compose.yml 的單純，所以把 <code>Certbot</code> Docker Image 的操作拆分。</p><p>動作步驟如下。</p><ul><li>建立 <code>Certbot</code> 與 docker-compose.yml 共用的 docker volume。</li><li>調整 docker-compose.yml 中，掛載 docker volume。</li><li>調整 NGINX 使用的 nginx.conf。</li><li>建立並運行 <code>Certbot</code> 的 Container。</li></ul><p>首先，建立存放 Let&rsquo;s Encrypt <code>.well-known/acme-challenge</code> 驗證資料與發送 SSL/TLS 憑證的 docker volume。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 存放 Let&#39;s Encrypt 發放的 SSL/TLS 憑證</span>
</span></span><span style=display:flex><span>sudo docker volume create letsencrypt-certs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 存放 Let&#39;s Encrypt acme-challenge 驗證資料</span>
</span></span><span style=display:flex><span>sudo docker volume create letsencrtpt-acme
</span></span></code></pre></div><p>接著，調整 docker-compose.yml，將 <code>letsencrypt-certs</code> 與 <code>letsencrtpt-acme</code> 兩個 docker volume 掛上去。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.gitlab.com/url-insight/url-insight/web:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./nginx.conf:/etc/nginx/nginx.conf:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>letsencrtpt-acme:/usr/share/nginx/html/acme</span> <span style=color:#75715e># --webroot 使用</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>letsencrypt-certs:/etc/letsencryptexit</span> <span style=color:#75715e># for Let&#39;s Encrypt certificates</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      -  <span style=color:#ae81ff>gateway-web</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>	<span style=color:#f92672>letsencrypt-certs</span>: <span style=color:#75715e># Define the volume for Let&#39;s Encrypt certificates</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>letsencrtpt-acme</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>調整完 docker-compose.yml 後，接著來調整 NIGIX 的設定。</p><p>在這邊，<code>ssl_certificate</code> 與 <code>ssl_certificate_key</code> 預設使用 Let&rsquo;s Encrypt SSL/TLS 的資料夾位置。實務上，可以依自行規劃進行調整指定的位置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx.conf data-lang=nginx.conf><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span> <span style=color:#f92672>server{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>url-ins.com</span> <span style=color:#e6db74>www.url-ins.com</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_tokens</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>      <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$host$request_uri;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>default_server</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:443</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>url-ins.com</span> <span style=color:#e6db74>www.url-ins.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_protocols</span>   <span style=color:#e6db74>TLSv1.2</span> <span style=color:#e6db74>TLSv1.3</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/letsencrypt/live/url-ins.com/fullchain.pem</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/letsencrypt/live/url-ins.com/privkey.pem</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>完成前面的設定後，就是使用 <code>docker compose up</code> 把 NGINX 站台啟動。</p><p>接著啟動 Certbot 的 Containr，進行 Let&rsquo;s Encrypt 的 SSL/TLS 憑證申請。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker run -it --rm --name certbot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -v <span style=color:#e6db74>&#34;letsencrypt-certs:/etc/letsencrypt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -v <span style=color:#e6db74>&#34;letsencrypt-acme:/var/lib/letsencrypt&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            certbot/certbot certonly
</span></span></code></pre></div><h2 id=補充資料>補充資料</h2><p>▶ 站內文章</p><ul><li><a href=../../../Publish/Series/side-project/%E7%B8%AE%E7%B6%B2%E5%9D%80%E6%9C%8D%E5%8B%99%E5%AF%A6%E4%BD%9C%E8%A8%98%E9%8C%84(1)%20-%20%E5%9F%BA%E6%96%BC%20Docker%20%E5%AE%B9%E5%99%A8%E6%8A%80%E8%A1%93%E7%9A%84%E7%B6%B2%E7%AB%99%E6%9C%8D%E5%8B%99%E6%9E%B6%E6%A7%8B%E5%AF%A6%E8%B8%90.md>縮網址服務實作記錄(1) - 基於 Docker 容器技術的網站服務架構實踐</a></li></ul><p>▶ 外部文章</p><p>中文資源</p><ul><li><a href=https://jonny-huang.github.io/docker/docker_03/>不合理的要求是磨練：Docker 架站 | Jonny Huang 的學習筆記</a></li><li><a href=https://blog.hellojcc.tw/setup-https-with-letsencrypt-on-nginx/>設定 Let&rsquo;s Encrypt HTTPS nginx certbot SSL 憑證自動更新 教學</a></li></ul><p>英文資源</p><ul><li><a href=https://eff-certbot.readthedocs.io/en/latest/using.html#where-certs>User Guide — Certbot 2.7.0.dev0 documentation</a></li><li><a href=https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/>Using Free Let’s Encrypt SSL/TLS Certificates with NGINX</a></li><li><a href=https://mindsers.blog/en/post/https-using-nginx-certbot-docker/>How to handle HTTPS using Nginx, Let&rsquo;s encrypt and Docker - Mindsers Blog</a></li><li><a href=https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71>Nginx and Let’s Encrypt with Docker in Less Than 5 Minutes | by Philipp | Medium</a></li><li><a href=https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04>How To Secure Nginx with Let&rsquo;s Encrypt on Ubuntu 20.04 | DigitalOcean</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/docker/ rel=tag>Docker</a>
<a class=tag href=/tags/nginx/ rel=tag>Nginx</a>
<a class=tag href=/tags/traefik/ rel=tag>Traefik</a></ul></div></footer><hr><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feandev.com%2fpost%2fseries%2fside-project%2fshorten-2-lets-encrypt-setting%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.min.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/series/side-project/shorten-1-build-service-base-on-container/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Docker | 縮網址服務實作記錄 (1) - 基於 Docker 容器技術的網站服務架構實踐</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div></body></html>