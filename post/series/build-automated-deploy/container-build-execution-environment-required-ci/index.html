<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>使用 Container 建立 CI 所需要的建置環境 - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="對於 docker/container 有基本概念後，接著要與 CI/CD 的工具搭配使用，讓 CI Server 同時支援更多不同的環境的要求。本篇文章會以 Travis CI、Azure DevOps、Jenkins 為例。"><meta property="og:title" content="使用 Container 建立 CI 所需要的建置環境"><meta property="og:description" content="對於 docker/container 有基本概念後，接著要與 CI/CD 的工具搭配使用，讓 CI Server 同時支援更多不同的環境的要求。本篇文章會以 Travis CI、Azure DevOps、Jenkins 為例。"><meta property="og:type" content="article"><meta property="og:url" content="https://eandev.com/post/series/build-automated-deploy/container-build-execution-environment-required-ci/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-10T16:15:41+00:00"><meta property="article:modified_time" content="2023-01-10T16:15:41+00:00"><meta itemprop=name content="使用 Container 建立 CI 所需要的建置環境"><meta itemprop=description content="對於 docker/container 有基本概念後，接著要與 CI/CD 的工具搭配使用，讓 CI Server 同時支援更多不同的環境的要求。本篇文章會以 Travis CI、Azure DevOps、Jenkins 為例。"><meta itemprop=datePublished content="2023-01-10T16:15:41+00:00"><meta itemprop=dateModified content="2023-01-10T16:15:41+00:00"><meta itemprop=wordCount content="1585"><meta itemprop=keywords content="Docker,"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Container 建立 CI 所需要的建置環境"><meta name=twitter:description content="對於 docker/container 有基本概念後，接著要與 CI/CD 的工具搭配使用，讓 CI Server 同時支援更多不同的環境的要求。本篇文章會以 Travis CI、Azure DevOps、Jenkins 為例。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=/css/style.min.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4HXSCXTZKZ",{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img alt=logo src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用 Container 建立 CI 所需要的建置環境</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-01-10T16:15:41Z>2023-01-10</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/devops/ rel=category>DevOps</a>, <a class=meta__link href=/categories/container/ rel=category>container</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#travis-ci>Travis CI</a></li><li><a href=#azure-devops>Azure DevOps</a></li><li><a href=#jenkins>Jenkins</a></li><li><a href=#延伸閱讀>延伸閱讀</a></li></ul></nav></div></div><div class="content post__content clearfix"><blockquote><p><a href=https://ithelp.ithome.com.tw/users/20107551/ironman/1906>2019 iT 邦幫忙鐵人賽</a>文章補完計劃，<a href=https://eandev.com/post/series/build-automated-deploy/build-ci-cd-from-scratch/#container>從零開始建立自動化發佈的流水線</a> Container 篇</p></blockquote><p>在 <a href=https://eandev.com/post/series/build-automated-deploy/docker-operate/>Docker 操作簡介</a> 中，初步了解 Docker、dockerfile、docker-compose 的操作方法。</p><p>接下來，要與 CI Server 搭配使用，讓 CI Server 可以依據設定檔，使用 docker 的方式，建置出執行 CI 所需要的環境。</p><h2 id=travis-ci>Travis CI</h2><p>在 <a href=https://docs.travis-ci.com/user/docker/>Travis CI 官方文件</a>中，提到使用 <code>docker</code> 與 <code>docker-compose</code> 兩種建置方式，若想更進一步查看詳細資訊，建議直接進入 Travis CI 官網文件 <a href=https://docs.travis-ci.com/user/docker/>Using Docker in Builds</a>觀看。</p><p>在 Travis CI 的服務，所有與 CI 相關的設定，預設都寫在 <code>.travis.yml</code> 之中，所以若要使用 Docker 進行建置，必須在 <code>.travis.yml</code> 加入以下設定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker</span>
</span></span></code></pre></div><p>在官方提供的 <code>travis.yml</code> 範例中，在 <code>before_install</code> 區塊，直接使用 docker command 進行設定與執行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># .travis.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>sudo</span>: <span style=color:#ae81ff>required</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>language</span>: <span style=color:#ae81ff>ruby</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>before_install</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker build -t carlad/sinatra .</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker run -d -p 127.0.0.1:80:4567 carlad/sinatra /bin/sh -c &#34;cd /root/sinatra; bundle exec foreman start;&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker ps -a</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker run carlad/sinatra /bin/sh -c &#34;cd /root/sinatra; bundle exec rake test&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>bundle exec rake test</span>
</span></span></code></pre></div><p>同時，Travis CI 預設已經安裝完成 <code>docker-compose</code>，所以可以直接使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose run test</span>
</span></span></code></pre></div><p>若是想要指定替換特定版本的 <code>docker-compose</code>，也可以參考官方提供的 <code>travis.yml</code> 範例。</p><p>在 <code>before_install</code> 區塊，進行 <code>docker-compose</code> 的下載與替換。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>DOCKER_COMPOSE_VERSION=1.4.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>before_install</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>sudo rm /usr/local/bin/docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>chmod +x docker-compose</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>sudo mv docker-compose /usr/local/bin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>docker-compose run test</span>
</span></span></code></pre></div><h2 id=azure-devops>Azure DevOps</h2><p>在 Azure DevOps 中，Azure Pipelins 負責 CI/CD 的動作。而 CI/CD 的執行動作設定，預設於 <code>azure-pipelines.yml</code>。若要在 <code>azure-pipeline.yml</code> 使用 docker/container，目前有查到 Microsoft 官方提供三種設定方式。</p><p>⚠️ 此三種方式未實際操作，僅提供參考，請小心服用。⚠️</p><p>方法一、在 <code>azure-pipelines.yml</code> 的 job，直接指定使用 <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/process/container-phases?view=azure-devops">Container Jobs</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>pool</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>vmImage</span>: <span style=color:#e6db74>&#39;windows-2019&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>container</span>: <span style=color:#ae81ff>mcr.microsoft.com/windows/servercore:ltsc2019</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>script</span>: <span style=color:#ae81ff>set</span>
</span></span></code></pre></div><p>方法二、在 <code>azure-pipelines.yml</code> 的 <code>task</code> 的宣告，直接告知使用 <a href=https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-v0><code>Docker@0</code></a>、<a href=https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-v2><code>Docker@1</code></a> 或 <a href=https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-v2><code>Docker@2</code></a>，但詳細參數均有所不同，詳細資訊請參閱官方文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Docker v1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build, tag, push, or run Docker images, or run a Docker command.</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Docker@1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># Container Registry</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerregistrytype: &#39;Azure Container Registry&#39; # &#39;Azure Container Registry&#39; | &#39;Container Registry&#39;. Required. Container registry type. Default</span>: <span style=color:#ae81ff>Azure Container Registry.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerRegistryEndpoint: # string. Optional. Use when containerregistrytype = Container Registry. Docker registry service connection. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#azureSubscriptionEndpoint: # string. Optional. Use when containerregistrytype = Azure Container Registry. Azure subscription. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#azureContainerRegistry: # string. Optional. Use when containerregistrytype = Azure Container Registry. Azure container registry. </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Commands</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#addBaseImageData: true # boolean. Add base image metadata to image(s). Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command: &#39;Build an image&#39; # &#39;Build an image&#39; | &#39;Tag image&#39; | &#39;Push an image&#39; | &#39;Run an image&#39; | &#39;login&#39; | &#39;logout&#39;. Required. Command. Default</span>: <span style=color:#ae81ff>Build an image.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerFile: &#39;**/Dockerfile&#39; # string. Required when command = Build an image || command = build. Dockerfile. Default: **/Dockerfile.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#arguments: # string. Optional. Use when command != login &amp;&amp; command != logout. Arguments. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#pushMultipleImages: false # boolean. Optional. Use when command = Push an image || command = push. Push multiple images. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#tagMultipleImages: false # boolean. Optional. Use when command = Tag image || command = tag. Tag multiple images. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#imageName: &#39;$(Build.Repository.Name):$(Build.BuildId)&#39; # string. Required when command = Build an image || command = build || command = Run an image || command = run || pushMultipleImages = false || tagMultipleImages = false. Image name. Default: $(Build.Repository.Name):$(Build.BuildId).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#imageNamesPath: # string. Required when tagMultipleImages = true || pushMultipleImages = true. Image names path. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#qualifyImageName: true # boolean. Optional. Use when command = Build an image || command = build || command = Tag image || command = tag || command = Push an image || command = push || command = Run an image || command = run. Qualify image name. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#qualifySourceImageName: false # boolean. Optional. Use when command = Tag image || command = tag. Qualify source image name. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#includeSourceTags: false # boolean. Optional. Use when command = Build an image || command = build || command = Tag image || command = tag  || command = Push an image || command = push. Include source tags. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#includeLatestTag: false # boolean. Optional. Use when command = Build an image || command = build. Include latest tag. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#addDefaultLabels: true # boolean. Optional. Use when addDefaultLabels = false. Add default labels. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#useDefaultContext: true # boolean. Optional. Use when command = Build an image || command = build. Use default build context. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#buildContext: # string. Optional. Use when useDefaultContext = false. Build context. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#imageDigestFile: # string. Optional. Use when command = Push an image || command = push. Image digest file. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#containerName: # string. Optional. Use when command = Run an image || command = run. Container name. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#ports: # string. Optional. Use when command = Run an image || command = run. Ports. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#volumes: # string. Optional. Use when command = Run an image || command = run. Volumes. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#envVars: # string. Optional. Use when command = Run an image || command = run. Environment variables. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#workingDirectory: # string. Optional. Use when command = Run an image || command = run. Working directory. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#entrypointOverride: # string. Optional. Use when command = Run an image || command = run. Entry point override. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#containerCommand: # string. Optional. Use when command = Run an image || command = run. Container command. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#runInBackground: true # boolean. Optional. Use when command = Run an image || command = run. Run in background. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restartPolicy: &#39;no&#39; # &#39;no&#39; | &#39;onFailure&#39; | &#39;always&#39; | &#39;unlessStopped&#39;. Required when runInBackground = true. Restart policy. Default</span>: <span style=color:#66d9ef>no</span><span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#maxRestartRetries: # string. Optional. Use when runInBackground = true &amp;&amp; restartPolicy = onFailure. Maximum restart retries. </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Advanced Options</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerHostEndpoint: # string. Docker host service connection. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#enforceDockerNamingConvention: true # boolean. Force image name to follow Docker naming convention. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#memoryLimit: # string. Memory limit.</span>
</span></span></code></pre></div><p>作法三、在 <code>azure-pipelines.yml</code> 的 <code>task</code> 的宣告，直接告知使用 <a href=https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-compose-v0><code>DockerCompose@0</code></a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>script</span>: <span style=color:#ae81ff>|</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Docker Compose v0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build, push or run multi-container Docker applications. Task can be used with Docker or Azure Container registry.</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>DockerCompose@0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerregistrytype: &#39;Azure Container Registry&#39; # &#39;Azure Container Registry&#39; | &#39;Container Registry&#39;. Required. Container Registry Type. Default</span>: <span style=color:#ae81ff>Azure Container Registry.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerRegistryEndpoint: # string. Optional. Use when containerregistrytype = Container Registry. Docker Registry Service Connection. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#azureSubscription: # string. Alias: azureSubscriptionEndpoint. Optional. Use when containerregistrytype = Azure Container Registry. Azure subscription. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#azureContainerRegistry: # string. Optional. Use when containerregistrytype = Azure Container Registry. Azure Container Registry. </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerComposeFile: &#39;**/docker-compose.yml&#39; # string. Required. Docker Compose File. Default</span>: <span style=color:#75715e>**/docker-compose.yml.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#additionalDockerComposeFiles: # string. Additional Docker Compose Files. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerComposeFileArgs: # string. Environment Variables. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#projectName: &#39;$(Build.Repository.Name)&#39; # string. Project Name. Default: $(Build.Repository.Name).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#qualifyImageNames: true # boolean. Qualify Image Names. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action: &#39;Run a Docker Compose command&#39; # &#39;Build services&#39; | &#39;Push services&#39; | &#39;Run services&#39; | &#39;Run a specific service&#39; | &#39;Lock services&#39; | &#39;Write service image digests&#39; | &#39;Combine configuration&#39; | &#39;Run a Docker Compose command&#39;. Required. Action. Default</span>: <span style=color:#ae81ff>Run a Docker Compose command.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#additionalImageTags: # string. Optional. Use when action = Build services || action = Push services. Additional Image Tags. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#includeSourceTags: false # boolean. Optional. Use when action = Build services || action = Push services. Include Source Tags. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#includeLatestTag: false # boolean. Optional. Use when action = Build services || action = Push services. Include Latest Tag. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#buildImages: true # boolean. Optional. Use when action = Run services. Build Images. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#serviceName: # string. Required when action = Run a specific service. Service Name. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#containerName: # string. Optional. Use when action = Run a specific service. Container Name. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#ports: # string. Optional. Use when action = Run a specific service. Ports. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#workingDirectory: # string. Alias: workDir. Optional. Use when action = Run a specific service. Working Directory. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#entrypoint: # string. Optional. Use when action = Run a specific service. Entry Point Override. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#containerCommand: # string. Optional. Use when action = Run a specific service. Command. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#detached: true # boolean. Optional. Use when action = Run services || action = Run a specific service. Run in Background. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#abortOnContainerExit: true # boolean. Optional. Use when action = Run services &amp;&amp; detached == false. Abort on Container Exit. Default: true.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#imageDigestComposeFile: &#39;$(Build.StagingDirectory)/docker-compose.images.yml&#39; # string. Required when action = Write service image digests. Image Digest Compose File. Default: $(Build.StagingDirectory)/docker-compose.images.yml.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#removeBuildOptions: false # boolean. Optional. Use when action = Lock services || action = Combine configuration. Remove Build Options. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#baseResolveDirectory: # string. Optional. Use when action = Lock services || action = Combine configuration. Base Resolve Directory. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#outputDockerComposeFile: &#39;$(Build.StagingDirectory)/docker-compose.yml&#39; # string. Required when action = Lock services || action = Combine configuration. Output Docker Compose File. Default: $(Build.StagingDirectory)/docker-compose.yml.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerComposeCommand: # string. Required when action = Run a Docker Compose command. Command. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#arguments: # string. Optional. Use when action != Lock services &amp;&amp; action != Combine configuration &amp;&amp; action != Write service image digests. Arguments. </span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Advanced Options</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerHostEndpoint: # string. Docker Host Service Connection. </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#nopIfNoDockerComposeFile: false # boolean. No-op if no Docker Compose File. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#requireAdditionalDockerComposeFiles: false # boolean. Require Additional Docker Compose Files. Default: false.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#currentWorkingDirectory: &#39;$(System.DefaultWorkingDirectory)&#39; # string. Alias: cwd. Working Directory. Default: $(System.DefaultWorkingDirectory).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#dockerComposePath: # string. Docker Compose executable Path.</span>
</span></span></code></pre></div><h2 id=jenkins>Jenkins</h2><p>如果曾經使用 Jenkins 進行發佈，或許對 pipeline 並不陌生。</p><p>在 Pipeline 中，Jenkins 會依據 <code>jenkinsfile</code> 內容的指示執行各種動作。運用 Groovy 的格式來撰寫 <code>jenkinsfile</code> 讓使用者可以客制化建置的流程與環境。</p><p><figure><center><img src=Images/jenkins_pipeline.png alt="Jenkins pipeline 設定"><figcaption>Jenkins pipeline 設定</figcaption></center></figure></p><p>經由 <code>jenkinsfile</code> 與 docker 的配合，我們可以自行訂定各 <strong>階段 (stages)</strong> ，使用不同 Docker Image 建置環境，執行不同的動作。而無需手動配置環境。</p><p>下面的範例，將會使用 Nodejs <code>7-alpine</code> 版本的 docker image 作為執行環境。並在<code>測試階段</code>，執行 node.js 的相關動作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>Jenkinsfile <span style=color:#f92672>(</span>Declarative Pipeline<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        docker <span style=color:#f92672>{</span> image <span style=color:#e6db74>&#39;node:7-alpine&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Test&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                sh <span style=color:#e6db74>&#39;node --version&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=延伸閱讀>延伸閱讀</h2><p>▶ Travis CI</p><ul><li>Travis CI Document, <a href=https://docs.travis-ci.com/user/docker/>Using Docker in Builds</a></li></ul><p>▶ Azure Devops</p><ul><li><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/process/container-phases?view=azure-devops">Container Jobs in Azure Pipelines and TFS - Azure Pipelines | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/ecosystems/containers/build-image?view=azure-devops&amp;tabs=yaml&amp;viewFallbackFrom=vsts#example">Build container images to deploy apps - Azure Pipelines | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-v1?view=azure-pipelines">Docker@1 - Docker v1 task | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/docker-compose-v0?source=recommendations&amp;view=azure-pipelines">DockerCompose@0 - Docker Compose v0 task | Microsoft Learn</a></li></ul><p>▶ Jenkins</p><ul><li>Jenkins Document, <a href=https://jenkins.io/doc/book/pipeline/docker/>Using Docker with Pipeline</a></li><li>Miiro Juuso, <a href=https://getintodevops.com/blog/building-your-first-docker-image-with-jenkins-2-guide-for-developers>Building your first Docker image with Jenkins 2: Guide for developers</a></li><li>Gustavo Apolinario, <a href=https://medium.com/@gustavo.guss/jenkins-building-docker-image-and-sending-to-registry-64b84ea45ee9>Jenkins Building Docker Image and Sending to Registry</a></li><li><a href=http://blog.51cto.com/wzlinux/2166241>持续集成之 Jenkins 通过 Deploy 插件热部署 java 程序(九)</a></li><li><a href=https://www.nielsvandermolen.com/continuous-integration-jenkins-docker/>A continuous integration pipeline with Jenkins in Docker</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/docker/ rel=tag>Docker</a></ul></div></footer><hr><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feandev.com%2fpost%2fseries%2fbuild-automated-deploy%2fcontainer-build-execution-environment-required-ci%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.min.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/series/build-automated-deploy/docker-operate/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Docker 操作簡介 - command / dockerfile / docker-compose</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/series/build-automated-deploy/build-docker-image/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>使用 Azure Pipelines / Jenkins 建置 Docker image</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//eanblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div></body></html>