#
# Obsidian è½‰ Astro ä¸¦éƒ¨ç½²åˆ° GitHub Pages çš„å·¥ä½œæµç¨‹
#
# ç•¶ obsidian-vault/ ç›®éŒ„æœ‰æ›´æ–°æ™‚ï¼š
# 1. è½‰æ› Obsidian æ ¼å¼æ–‡ç« ç‚º Astro æ ¼å¼
# 2. å»ºç½® Astro ç¶²ç«™
# 3. éƒ¨ç½²åˆ° GitHub Pages
#

name: è½‰æ›ä¸¦éƒ¨ç½²

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯ï¼Œä¸”å½±éŸ¿ obsidian-vault/ æ™‚è§¸ç™¼
  push:
    branches: [main]
    paths:
      - 'obsidian-vault/publish/**'
      - 'obsidian-vault/images/**'
      - 'converter.ts'
      - '.github/workflows/convert-and-deploy.yml'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# è¨­å®š GITHUB_TOKEN æ¬Šé™ä»¥éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è¨±ä¸€æ¬¡éƒ¨ç½²ï¼Œé¿å…ä¸¦ç™¼
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BUILD_PATH: "."

jobs:
  # ==================== è½‰æ›ä¸¦å»ºç½® ====================
  convert-and-build:
    name: è½‰æ›æ–‡ç« ä¸¦å»ºç½®ç¶²ç«™
    runs-on: ubuntu-latest

    steps:
      # ---------- 1. æª¢å‡ºä»£ç¢¼ ----------
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      # ---------- 2. è¨­å®š Node.js ----------
      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ---------- 3. å®‰è£ TypeScript å’Œ ts-node ----------
      - name: ğŸ“¦ å®‰è£ TypeScript ç’°å¢ƒ
        run: |
          npm install -g typescript ts-node @types/node
          echo "âœ… TypeScript ç’°å¢ƒå·²å®‰è£"

      # ---------- 4. é‹è¡Œè½‰æ›å·¥å…· ----------
      - name: ğŸ”„ è½‰æ› Obsidian æ–‡ç« ç‚º Astro æ ¼å¼
        run: |
          echo "ğŸš€ é–‹å§‹è½‰æ›æ–‡ç« ..."
          ts-node converter.ts
          echo "âœ… è½‰æ›å®Œæˆ"

      # ---------- 5. é©—è­‰è½‰æ›çµæœ ----------
      - name: ğŸ” é©—è­‰è½‰æ›çµæœ
        run: |
          if [ ! -d "src/content/blog" ]; then
            echo "âŒ éŒ¯èª¤ï¼šsrc/content/blog ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          fi

          article_count=$(find src/content/blog -name "index.md" | wc -l)
          echo "âœ… æˆåŠŸè½‰æ› $article_count ç¯‡æ–‡ç« "

          if [ $article_count -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²’æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ç« "
            exit 1
          fi

      # ---------- 6. åµæ¸¬å¥—ä»¶ç®¡ç†å™¨ ----------
      - name: ğŸ” åµæ¸¬å¥—ä»¶ç®¡ç†å™¨
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=yarn" >> $GITHUB_OUTPUT
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f "${{ github.workspace }}/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=pnpm" >> $GITHUB_OUTPUT
            echo "lockfile=pnpm-lock.yaml" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            echo "runner=npx --no-install" >> $GITHUB_OUTPUT
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          fi

      # ---------- 7. è¨­å®š Pages ----------
      - name: âš™ï¸  è¨­å®š GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      # ---------- 8. å®‰è£ Astro ä¾è³´ ----------
      - name: ğŸ“¦ å®‰è£ Astro ä¾è³´
        run: |
          ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
        working-directory: ${{ env.BUILD_PATH }}

      # ---------- 9. å»ºç½® Astro ç¶²ç«™ ----------
      - name: ğŸ—ï¸  å»ºç½® Astro ç¶²ç«™
        run: |
          ${{ steps.detect-package-manager.outputs.runner }} astro build \
            --site "${{ steps.pages.outputs.origin }}" \
            --base "${{ steps.pages.outputs.base_path }}"
        working-directory: ${{ env.BUILD_PATH }}

      # ---------- 10. ä¸Šå‚³å»ºç½®ç”¢ç‰© ----------
      - name: ğŸ“¤ ä¸Šå‚³å»ºç½®ç”¢ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_PATH }}/dist

  # ==================== éƒ¨ç½² ====================
  deploy:
    name: éƒ¨ç½²åˆ° GitHub Pages
    needs: convert-and-build
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ---------- éƒ¨ç½²åˆ° GitHub Pages ----------
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
