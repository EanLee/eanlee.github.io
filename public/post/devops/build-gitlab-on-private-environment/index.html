<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置 - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="在上一篇文章，已經成功在本機建立好 GitLab CI 的環境了，接下來，改在私用的環境，將 GitLab CI 與 Runner 分別建立，並讓 GitLab CI 順利運行。"><meta property="og:title" content="GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置"><meta property="og:description" content="在上一篇文章，已經成功在本機建立好 GitLab CI 的環境了，接下來，改在私用的環境，將 GitLab CI 與 Runner 分別建立，並讓 GitLab CI 順利運行。"><meta property="og:type" content="article"><meta property="og:url" content="https://eandev.com/post/devops/build-gitlab-on-private-environment/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-09-12T02:16:34+00:00"><meta property="article:modified_time" content="2022-09-12T02:16:34+00:00"><meta itemprop=name content="GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置"><meta itemprop=description content="在上一篇文章，已經成功在本機建立好 GitLab CI 的環境了，接下來，改在私用的環境，將 GitLab CI 與 Runner 分別建立，並讓 GitLab CI 順利運行。"><meta itemprop=datePublished content="2022-09-12T02:16:34+00:00"><meta itemprop=dateModified content="2022-09-12T02:16:34+00:00"><meta itemprop=wordCount content="638"><meta itemprop=keywords content="GitLab,"><meta name=twitter:card content="summary"><meta name=twitter:title content="GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置"><meta name=twitter:description content="在上一篇文章，已經成功在本機建立好 GitLab CI 的環境了，接下來，改在私用的環境，將 GitLab CI 與 Runner 分別建立，並讓 GitLab CI 順利運行。"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=/css/style.min.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-4HXSCXTZKZ',{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img alt=logo src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>GitLab CI 實作記錄(2) - Gitlab CI 的私有環境建置</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-09-12T02:16:34Z>2022-09-12</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/devops/ rel=category>DevOps</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#網路架設與規劃>網路架設與規劃</a></li><li><a href=#建立-gitlab-server>建立 Gitlab Server</a></li><li><a href=#設定-gitlab-runner>設定 Gitlab-Runner</a><ul><li><a href=#建立-runner-的-executor>建立 Runner 的 Executor</a></li><li><a href=#executor-使用自建的-image>Executor 使用自建的 Image</a></li></ul></li><li><a href=#補充資料>補充資料</a><ul><li><a href=#延伸閱讀>延伸閱讀</a></li><li><a href=#參考資料>參考資料</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>延續上一篇 <a href=GitLab%20CI%20%E5%AF%A6%E4%BD%9C%E8%A8%98%E9%8C%84(1)%20-%20%E4%BD%BF%E7%94%A8%20Docker%20%E5%9C%A8%E5%90%8C%E5%8F%B0%E4%B8%BB%E6%A9%9F%E9%81%8B%E8%A1%8C%20GitLab%20%E8%88%87%20GitLab-Runner.md>GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner</a> 的結果，接著要開始進行 GitLab CI 的環境架設。</p><p>架設的環境</p><ul><li>Gitlab EE</li><li>Gitlab Runner ver.1.5.1</li><li>OS: Ubuntu 20.4</li></ul><h2 id=網路架設與規劃>網路架設與規劃</h2><p>在開始架設之前，有幾個要求(限制)。</p><ul><li>CI/CD 的主機不可以暴露於公開環境</li><li>CI 主機對外連線需要控管。</li></ul><p><figure><center><img src=images/network_arch.png alt="Netowrk arch"><figcaption>Netowrk arch</figcaption></center></figure></p><h2 id=建立-gitlab-server>建立 Gitlab Server</h2><p>直接使用 docker-compose 來架設 GitLab</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.6&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gitlab/gitlab-ee:latest&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hostname</span>: <span style=color:#e6db74>&#39;gitlab.mycode.it&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>GITLAB_OMNIBUS_CONFIG</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        external_url &#39;https://gitlab.mycode.it&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # Add any other gitlab.rb configuration here, each on its own line</span>        
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;80:80&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;443:443&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;22:22&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;gitlab_data:/etc/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;gitlab_log:/var/log/gitlab&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;gitlab_opt:/var/opt/gitlab&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>shm_size</span>: <span style=color:#e6db74>&#39;256m&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>gitlab_data</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>gitlab_opt</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>gitlab_log</span>:
</span></span></code></pre></div><h2 id=設定-gitlab-runner>設定 Gitlab-Runner</h2><p>GitLab-Runner 的安裝與註冊方式，可參考 <a href=GitLab%20CI%20%E5%AF%A6%E4%BD%9C%E8%A8%98%E9%8C%84(1)%20-%20%E4%BD%BF%E7%94%A8%20Docker%20%E5%9C%A8%E5%90%8C%E5%8F%B0%E4%B8%BB%E6%A9%9F%E9%81%8B%E8%A1%8C%20GitLab%20%E8%88%87%20GitLab-Runner.md##%E8%A8%BB%E5%86%8A-gitlab-runner>註冊 GitLab-Runner</a> 的操作。</p><p>這時，設定好 Runner，並進行 CI/CD 的 Try-run 時，會發生 git clone 失敗的錯誤。</p><p><figure><center><img src=images/gitlab_job_fail_not_resolve_host.png alt="git clone fail"><figcaption>git clone fail</figcaption></center></figure></p><p>問題的原因在於網路環境的設定與規劃。</p><ul><li>GitLab Host 的防火牆，允許特定的外部 IP 與 <code>172.45.18.0/8</code> 連入。</li><li>CI Host 的防火牆 Engress Rule 僅允許放行對 GitLab Host Private IP 的連線。</li></ul><p>所以 CI Host 是無法直接使用 <a href=https://gitlab.mycode.it>https://gitlab.mycode.it</a> 指向 Gitlab Host 的，所以需要配合環境進行調整。</p><p>作法一：Runner 未註冊時，在 GitLab Runner 在註冊 Executor 時，需指定使用的 <code>url</code> 與 <code>clone-url</code> 位置為 GitLab Host 的 Private IP <code>172.45.20.1</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker exec -it gitlab-runner gitlab-runner register <span style=color:#ae81ff>\ </span> 
</span></span><span style=display:flex><span>  --url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clone-url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> 
</span></span></code></pre></div><p>作法二：若 Runner 已註冊，則到 Gitlab-runner 的 Container 內，在 <code>etc\gitlab-runner\config.toml</code> 中，加入參數 <code>clone-url</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-toml data-lang=toml><span style=display:flex><span>[[<span style=color:#a6e22e>runners</span>]]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;dotnet-core-3.1&#34;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span> = <span style=color:#e6db74>&#34;WxnmFkszXJFiqeQVxy--&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>executor</span> = <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#a6e22e>clone_url</span> = <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span>
</span></span><span style=display:flex><span>  ...
</span></span></code></pre></div><h3 id=建立-runner-的-executor>建立 Runner 的 Executor</h3><p>我們選擇 Ubuntu 做為 CI 的環境 OS，並在上面運行 Docker 版的 Runner 與 Executor。</p><p>⚠ 要特別注意，在 Windwos 的環境下，檔案名稱或路徑，無論大小寫，都視為相同。但是在 Linux 環境下，只要任一字元大小寫不同，就會視為不同的東西。</p><h4 id=針對-net-core-的專案>針對 .NET Core 的專案</h4><p>關於 .NET Core 的 Image 清單，可以參閱 <a href=https://mcr.microsoft.com/v2/dotnet/core/sdk/tags/list>Docker Hub</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker exec -it gitlab-runner gitlab-runner register <span style=color:#ae81ff>\ </span> 
</span></span><span style=display:flex><span>  --non-interactive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clone-url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --registration-token <span style=color:#e6db74>&#34;PROJECT_REGISTRATION_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --tag-list <span style=color:#e6db74>&#34;dotnet-core&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --description <span style=color:#e6db74>&#34;dotnet core runner&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --maintenance-note <span style=color:#e6db74>&#34;Free-form maintainer notes about this runner&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --executor <span style=color:#e6db74>&#34;docker&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --docker-image mcr.microsoft.com/dotnet/sdk:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --run-untagged<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># .gitlab-ci.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:          <span style=color:#75715e># List of stages for jobs, and their order of execution</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>dev-build-job</span>:       <span style=color:#75715e># This job runs in the build stage, which runs first.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tags</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;dotnet-core&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 還原 nuget packages</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>dotnet restore solution.sln</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 建置專案</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>dotnet build solution.sln</span>
</span></span></code></pre></div><h4 id=針對-net-framework-的專案>針對 .NET Framework 的專案</h4><p>通常找到的 GitLab CI 與 .NET Framework 的處理方式，會是使用 Shell 的 Executor。有興趣的人，可以參考 <a href=https://medium.com/@gabriel.faraday.barros/39220808b18f>GitLab CI/CD with .Net Framework</a> 進行實作。</p><p>但是我們想要統一使用 Docker Executor。</p><p>或許，會直覺想到使用 <code>mcr.microsoft.com/dotnet/framework/sdk:4.8</code> 作為 Docker Executor 的 Base Image。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 試著在 WSL2 或 Linux Kernal 的環境，執行下述指令</span>
</span></span><span style=display:flex><span>docker pull mcr.microsoft.com/dotnet/framework/sdk:4.8
</span></span></code></pre></div><p><figure><center><img src=images/no_match_manifest.png alt="no matching manifest for linux/amd64 in the manifest list entries"><figcaption>no matching manifest for linux/amd64 in the manifest list entries</figcaption></center></figure></p><p>結果發生 <code>no matching manifest for linux/amd64 in the manifest list entries</code> 的錯誤訊息。</p><p>雖然 <code>mcr.microsoft.com/dotnet/framework/sdk:4.8</code> 已經整合好 <code>.NET Framework Runtime</code>、<code>Visual Studio Build Tools</code>、<code>Visual Studio Test Agent</code>、<code>NuGet CLI</code> 等等， 但是它的底層使用的 HOST OS 必需是 windows，所以只要是用使用 WSL2 或是 Linux kernal 的 Docker 均無法使用。</p><p>因為規劃是使用 Docker Executor on Linux 的環境，所以這條路不通。</p><p>還好有 mono 的專案，可以提供 .NET Framework 使用於 Linux 之上，所以改用 mono 的 docker Image 作為 Executor 的 Base Image。(<a href=https://hub.docker.com/_/mono/tags>Docker Hub</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>docker pull mono<span style=color:#960050;background-color:#1e0010>:</span>latest
</span></span></code></pre></div><p>首先註冊一個使用 <code>mono</code> 的 docker Executor。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker exec -it gitlab-runner gitlab-runner register <span style=color:#ae81ff>\ </span> 
</span></span><span style=display:flex><span>  --non-interactive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --clone-url <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --registration-token <span style=color:#e6db74>&#34;PROJECT_REGISTRATION_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --tag-list <span style=color:#e6db74>&#34;mono-fx-docker&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --description <span style=color:#e6db74>&#34;docker-runner&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --maintenance-note <span style=color:#e6db74>&#34;Free-form maintainer notes about this runner&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --executor <span style=color:#e6db74>&#34;docker&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --docker-image moon:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --run-untagged<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>再來，就是撰寫 <code>.gitlab-ci.yml</code> 的時候了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e># .gitlab-ci.yml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:          <span style=color:#75715e># List of stages for jobs, and their order of execution</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build-job</span>:       <span style=color:#75715e># This job runs in the build stage, which runs first.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mono-fx-docker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>nuget restore solution.sln</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>msbuild solution.sln</span>
</span></span></code></pre></div><h3 id=executor-使用自建的-image>Executor 使用自建的 Image</h3><p>若是 Docker Executor 所使用的 Image，想要使用 <code>自行建立</code> 或是 <code>先使用本地已存在</code> 的 Image，就必需在 <code>etc\gitlab-runner\config.toml</code> 的 <code>[runners.docker]</code> 內，加入 <code>pull_policy = ["if-not-present"]</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-toml data-lang=toml><span style=display:flex><span>[[<span style=color:#a6e22e>runners</span>]]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;dotnet-core-3.1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span> = <span style=color:#e6db74>&#34;WxnmFkszXJFiqeQVxy--&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>executor</span> = <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clone_url</span> = <span style=color:#e6db74>&#34;http://172.45.20.1&#34;</span>
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>docker</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tls_verify</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>image</span> = <span style=color:#e6db74>&#34;mcr.microsoft.com/dotnet/sdk:3.1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>privileged</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>disable_entrypoint_overwrite</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>oom_kill_disable</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>disable_cache</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>volumes</span> = [<span style=color:#e6db74>&#34;/cache&#34;</span>]
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>pull_policy</span> = [<span style=color:#e6db74>&#34;if-not-present&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shm_size</span> = <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>讓 Docker Executor 知道，若使用的 Image 本地已存在，就直接使用本地的 Image，若不存在，Runner 則會嘗試去拉取 Image。</p><p>順帶一提，<code>pull_policy</code> 有 <code>never</code>, <code>if-not-present</code> 與 <code>always</code> 三種，若是沒有特別設定，預設用 <code>always</code>。</p><h2 id=補充資料>補充資料</h2><h3 id=延伸閱讀>延伸閱讀</h3><ul><li>iThome, <a href=https://www.ithome.com.tw/tech/29006>Mono 搭起 Linux 與.NET 的橋樑</a></li><li>GitHub, <a href=https://github.com/mono/docker>mono/docker</a></li><li>GitLab, <a href=https://docs.gitlab.com/runner/register/#one-line-registration-command>One-line registration command</a></li><li>GitLab, <a href=https://docs.gitlab.com/runner/executors/docker.htm>The Docker executor</a></li></ul><h3 id=參考資料>參考資料</h3><ul><li>stackoverflow, <a href=https://stackoverflow.com/questions/69281169/docker-image-cannot-used-in-gitlab-no-matching-manifest-for-linux-amd64-in-the>Docker image cannot used in GitLab : no matching manifest for linux/amd64 in the manifest list entries</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/gitlab/ rel=tag>GitLab</a></ul></div></footer><hr><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feandev.com%2fpost%2fdevops%2fbuild-gitlab-on-private-environment%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.min.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/devops/gitlab-and-runner-on-same-host-using-docker/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>GitLab CI 實作記錄(1) - 使用 Docker 在同台主機運行 GitLab 與 GitLab-Runner</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/develop/post-redirect-get/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>ASP.NET Core | Web API 的 Post-Redirect-Get 實作與注意事項</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//eanblog.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div></body></html>