<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>使用 dotnet-ef 建立 PostgreSQL 的 DBContext - 伊恩的開發狂想</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033" crossorigin=anonymous></script><meta name=description content="當 .NET Core 要使用 EF Core 去存取 PostgreSQL 時，可以先使用 dotnet-ef 的工具，協助產生對應 PostgreSQL schema 的 DBContext"><meta property="og:title" content="使用 dotnet-ef 建立 PostgreSQL 的 DBContext"><meta property="og:description" content="當 .NET Core 要使用 EF Core 去存取 PostgreSQL 時，可以先使用 dotnet-ef 的工具，協助產生對應 PostgreSQL schema 的 DBContext"><meta property="og:type" content="article"><meta property="og:url" content="https://eandev.com/post/develop/dotnet-ef-postgresql-dbcontext/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-02-13T04:13:02+00:00"><meta property="article:modified_time" content="2023-03-02T02:49:47+00:00"><meta itemprop=name content="使用 dotnet-ef 建立 PostgreSQL 的 DBContext"><meta itemprop=description content="當 .NET Core 要使用 EF Core 去存取 PostgreSQL 時，可以先使用 dotnet-ef 的工具，協助產生對應 PostgreSQL schema 的 DBContext"><meta itemprop=datePublished content="2023-02-13T04:13:02+00:00"><meta itemprop=dateModified content="2023-03-02T02:49:47+00:00"><meta itemprop=wordCount content="456"><meta itemprop=keywords content="EF Core,Postgresql,"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 dotnet-ef 建立 PostgreSQL 的 DBContext"><meta name=twitter:description content="當 .NET Core 要使用 EF Core 去存取 PostgreSQL 時，可以先使用 dotnet-ef 的工具，協助產生對應 PostgreSQL schema 的 DBContext"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=/css/style.min.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-4HXSCXTZKZ',{anonymize_ip:!1})}</script><link href=/css/syntax.min.css rel=stylesheet><link href=/css/copy-to-clipboard.min.css rel=stylesheet></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class="logo logo--mixed"><a class=logo__link href=/ title=伊恩的開發狂想 rel=home><div class="logo__item logo__imagebox"><img class=logo__img alt=logo src=/img/placeholder.png></div><div class="logo__item logo__text"><div class=logo__title>伊恩的開發狂想</div><div class=logo__tagline>在知識大海中漂流的小船，不停追尋屬於自己的秘寶。專注於 .NET、雲端技術、系統架構、開發技巧的道、法、術。</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用 dotnet-ef 建立 PostgreSQL 的 DBContext</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>伊恩</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-02-13T04:13:02Z>2023-02-13</time>
<time class=meta__text datetime=2023-03-02T02:49:47Z>(Last Modified: 2023-03-02)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/ rel=category>軟體開發</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#前置作業>前置作業</a><ul><li><a href=#建立-postgresql>建立 PostgreSQL</a></li><li><a href=#建立-net-core-lab-專案>建立 .NET Core Lab 專案</a></li></ul></li><li><a href=#entity-framework-core-tools>Entity Framework Core Tools</a><ul><li><a href=#ef-tool-的安裝與更新>EF Tool 的安裝與更新</a></li><li><a href=#產生-dbcontext>產生 DBContext</a></li><li><a href=#異常排除>異常排除</a></li></ul></li><li><a href=#user-secrets>user-secrets</a></li><li><a href=#延伸閱讀>延伸閱讀</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>若是有使用過 Entity Framework, EF 的經驗，必然對 <code>DBContext</code> 類別有所了解。在 EF 時可以使用 Visual Studo 的 UI 工具，以 Database-First 的方式建立 DBContext。</p><p>本篇文章則是記錄 Database-First 的開發方式下，EF Core 如何使用 CLI 來產生 DBContext。</p><blockquote><p>🔖 長話短說 🔖</p><ul><li>EF Core 要操作 PostgreSQL 的話，可使用 <code>Npgsql.EntityFrameworkCore.PostgreSQL</code></li><li>可使用 <code>dotnet tool update --global dotnet-ef</code> 進行 <code>dotnet-ef</code> 版本更新</li><li>可使用 <code>dotnet ef dbcontext scffold</code> 的指令，協助從資料庫已存在的 Schema 產生對應的 dbcontext。</li><li>若專案內未參考 <code>Microsoft.EntityFrameworkCore.Design</code> 的話，<code>dotnet ef dbcontext scffold</code> 無法順利動作。</li><li>機敏性資料，可使用 <code>user-secrets</code> 工具。</li></ul></blockquote><p>操作環境：</p><ul><li>Windows 11</li><li>.NET Core 7</li><li>Postgresql 15.1</li></ul><h2 id=前置作業>前置作業</h2><h3 id=建立-postgresql>建立 PostgreSQL</h3><p>選擇使用 Docker compose 的方式，來建立 PostgreSQL。</p><p>使用下面的 yml 設定，預設儲存為 <code>docker-compose.yml</code> 檔。當然也可以存為其他更具識別性的名稱。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.6&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>postgres</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:15.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=postgres</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=psg1234</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;5432:5432&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>postgres-data:/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>postgres-data</span>:
</span></span></code></pre></div><p>若是存為 <code>docker-compose.yml</code> 時，直接執行下述語法即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p>若是存為其他檔名時，需要使用 <code>-f</code> 指定 yml 的檔案。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker-compose -f &lt;docker-compose.yml&gt; up -d
</span></span></code></pre></div><p>接著建立一個簡單的表格。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> todo
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id    integer <span style=color:#66d9ef>generated</span> always <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>identity</span>,
</span></span><span style=display:flex><span>    title varchar(<span style=color:#ae81ff>30</span>)                         <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>    date  <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>current_timestamp</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=建立-net-core-lab-專案>建立 .NET Core Lab 專案</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 建立新的 console 專案</span>
</span></span><span style=display:flex><span>dotnet new webapi -n efcore_lab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd efcore_lab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安裝 Nuget 套件</span>
</span></span><span style=display:flex><span>dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version 7.0.1
</span></span><span style=display:flex><span>dotnet add package Microsoft.EntityFrameworkCore.Design
</span></span></code></pre></div><p><code>Npgsql.EntityFrameworkCore.PostgreSQL</code> 是 postgreSQL 的 DB Provider。</p><p>若是沒有安裝 <code>Microsoft.EntityFrameworkCore.Design</code>，後續執行 <code>dotnet ef dbcontext scffold ...</code> 的指令時，會出現錯誤提示。</p><p><figure><center><img src=images/uninstall-efcore-design-result.png alt="未安裝 Microsoft.EntityFrameworkCore.Design 的錯誤提示"><figcaption>未安裝 Microsoft.EntityFrameworkCore.Design 的錯誤提示</figcaption></center></figure></p><h2 id=entity-framework-core-tools>Entity Framework Core Tools</h2><h3 id=ef-tool-的安裝與更新>EF Tool 的安裝與更新</h3><p>使用 EF Core Tools 之前，需先進行安裝。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 將 dotnet ef 安裝為全域工具</span>
</span></span><span style=display:flex><span>dotnet tool install --global dotnet-ef
</span></span></code></pre></div><p>若曾經安裝過 dotnet-ef 的工具，但後續專案使用最新版本的 EF Core，在執行 <code>dotnet ef</code> 相關指令時，會出現以下的提示訊息。</p><p><code>The Entity Framework tools version '6.0.8' is older than that of the runtime '7.0.1'. Update the tools for the latest features and bug fixes. See https://aka.ms/AAc1fbw for more information.</code></p><p>當發生上述的訊息時，可以使用以下的指令來更新本機內的 EF Core 的 Tools 工具版本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> dotnet tool update --global dotnet-ef
</span></span></code></pre></div><h3 id=產生-dbcontext>產生 DBContext</h3><p>接著，就要運用 <code>dotnet ef dbcontext scaffold</code> 的指令，來協作我們產生對應資料庫的 DBContext 了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dotnet ef dbcontext scaffold &lt;connection_string&gt; Npgsql.EntityFrameworkCore.PostgreSQL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 例子</span>
</span></span><span style=display:flex><span>dotnet ef dbcontext scaffold <span style=color:#e6db74>&#34;Host=localhost;Database=postgres;Username=postgres;Password=psg1234;Trust Server Certificate=true&#34;</span> Npgsql.EntityFrameworkCore.PostgreSQL
</span></span></code></pre></div><p><figure><center><img src=images/success-dbcontext-scaffold.png alt="順利更新 DBContext"><figcaption>順利更新 DBContext</figcaption></center></figure></p><p>若是想要指定產生出來的 <code>&lt;DBContext.cs></code> 放到指定位置，記得額加使用 <code>-o &lt;Path></code> 的指令。否則產生出來的位置與 .csproj 的位置相同。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 指定 DBContext 輸出位置為 Models 資料夾</span>
</span></span><span style=display:flex><span>dotnet ef dbcontext scaffold &lt;connection_string&gt; Npgsql.EntityFrameworkCore.PostgreSQL -o Models
</span></span></code></pre></div><h3 id=異常排除>異常排除</h3><h4 id=狀況一資料庫不存在>狀況一、資料庫不存在</h4><p>若是連線字串內的 <code>Database</code> 名稱與實際資料庫名稱大小寫不同，會發生找不到資料庫的錯誤。要特別注意。</p><p>在這邊，刻意將連線字串內的 Database 名稱，由 <code>postgres</code> 改為 <code>Postgres</code>，會看到下述的錯誤訊息。</p><p><figure><center><img src=images/failed-dbcontext-scffold-dbname-differice.png alt=資料庫名稱大小寫不同，回應資料庫不存在><figcaption>資料庫名稱大小寫不同，回應資料庫不存在</figcaption></center></figure></p><h4 id=狀況二已存在檔案>狀況二、已存在檔案</h4><p>若先前已經有產生過 <code>&lt;DBContext></code> 相關檔案，直接執行指令會出現 <code>The following file(s) already exist in directory 'c:\Codes\lab\efcore_lab\': PostgresContext.cs,Todo.cs. Use the Force flag to overwrite these files.</code> 錯誤訊息。</p><p><figure><center><img src=images/failed-overwrite.png alt=已存在資料，需指定覆寫原有資料><figcaption>已存在資料，需指定覆寫原有資料</figcaption></center></figure></p><p>所以必須在指令加上 <code>-f</code>，告知 <code>ef dbcontext scaffold</code> 要覆寫先前已存在的檔案。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dotnet ef dbcontext scaffold &lt;connection_string&gt; Npgsql.EntityFrameworkCore.PostgreSQL -o Models -f
</span></span></code></pre></div><p>但要注意的是，上述的指令所產生出來 DBContext.cs 內，會含有連線字串，為了避免資訊外洩，務必記得移除，改用 configuration 注入的方式。</p><p><figure><center><img src=images/postgres-dbcontext.png alt="dotnet ef 產生出來的 PostgresContext 內容"><figcaption>dotnet ef 產生出來的 PostgresContext 內容</figcaption></center></figure></p><h2 id=user-secrets>user-secrets</h2><p>也可以使用 user-secrets 的方式，來管理機敏資料，避免連線字串直接記錄在程式碼之中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 待調整為 Postgresql 的方式</span>
</span></span><span style=display:flex><span>dotnet user-secrets init
</span></span><span style=display:flex><span>dotnet user-secrets set ConnectionStrings:lab &lt;connection_string&gt;
</span></span><span style=display:flex><span>dotnet ef dbcontext scaffold Name<span style=color:#f92672>=</span>ConnectionStrings:lab Npgsql.EntityFrameworkCore.PostgreSQL
</span></span></code></pre></div><p>當 <code>user-serets init</code> 初始化之後，會產生一組 <code>UserSecretsId</code>，並存在 .csproj 之中。</p><p><figure><center><img src=images/user-secrets-init.png alt="user-secrets init"><figcaption>user-secrets init</figcaption></center></figure></p><p><figure><center><img src=images/csproj-content.png alt="csproj 專案檔內的 UserSecretsId"><figcaption>csproj 專案檔內的 UserSecretsId</figcaption></center></figure></p><p>使用 <code>user-secrets set</code> 後，系統會把機敏資料存放到 <code>C:\Users\&lt;user>\AppData\Roaming\Microsoft\UserSecrets\&lt;UserSecretsId>\secrets.json</code> 之中。</p><p><figure><center><img src=images/user-secrets-setting-connectionstring.png alt="使用 user-secrets 設定連線字串"><figcaption>使用 user-secrets 設定連線字串</figcaption></center></figure><figure><center><img src=images/secrets-json-content.png alt="secrets.json 內的資料"><figcaption>secrets.json 內的資料</figcaption></center></figure></p><p>最後使用 <code>dotnet ef dbcontext scaffold</code> 使用 <code>user-secrets</code> 內的連線字串來產生 DBContext。可以發現連線字串不會被記錄在 DBContext 之中。</p><p><figure><center><img src=images/dbcontext-scaffold-user-secrets.png alt="使用 user-secrets 內的連線字串"><figcaption>使用 user-secrets 內的連線字串</figcaption></center></figure><figure><center><img src=images/postregs-dbcontext-context-user-secrets.png alt="使用 user-secrets 產生出來的 PostgresContext"><figcaption>使用 user-secrets 產生出來的 PostgresContext</figcaption></center></figure></p><h2 id=延伸閱讀>延伸閱讀</h2><ul><li><a href=https://www.npgsql.org/efcore/>Npgsql Entity Framework Core Provider | Npgsql Documentation</a></li><li><a href=https://learn.microsoft.com/zh-tw/ef/core/cli/>Entity Framework Core 工具參考 - EF Core | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/zh-tw/aspnet/core/security/app-secrets?view=aspnetcore-7.0&tabs=windows#enable-secret-storage">在開發中安全儲存應用程式密碼，ASP.NET Core | Microsoft Learn</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><a class=tag href=/tags/ef-core/ rel=tag>EF Core</a>
<a class=tag href=/tags/postgresql/ rel=tag>Postgresql</a></ul></div></footer><hr><div><p>文章內容均為個人學習記錄、心得與認知，若任何謬誤或建議，歡迎直接留言討論，一同成長。</p></div><iframe class=LikeCoin src="https://button.like.co/in/embed/wosilee/button?referrer=https%3a%2f%2feandev.com%2fpost%2fdevelop%2fdotnet-ef-postgresql-dbcontext%2f" height=200 width=100% frameborder=0></iframe>
<script src=/js/copy-code-clipboard.min.js></script></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/security/using-iis-create-and-complete-csr/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>使用 IIS 進行 SSL 憑證的申請與更新的步驟與注意事項</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/post/develop/dotnet-ef-sqlserver/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>使用 dotnet-ef 建立 SQL Server on Docker 的 DBContext</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//eanblog.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 伊恩軟體技術學習與分享.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div></body></html>