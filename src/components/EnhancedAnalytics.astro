---
// 增強的 Google Analytics 事件追蹤
// 追蹤用戶互動行為以優化內容和使用者體驗

interface Props {
  enabled?: boolean;
}

const { enabled = true } = Astro.props;
---

{enabled && (
  <script is:inline>
    // requestIdleCallback polyfill（iOS Safari / 舊版 Edge 不支援）
    var _ric = window.requestIdleCallback || function(cb) { setTimeout(cb, 1); };

    // 跨頁追蹤：記錄上一次的 AbortController 和 MutationObservers
    var _analyticsController = null;
    var _analyticsObservers = [];

    // 確保 gtag 函數存在
    function ensureGtag() {
      return typeof gtag !== 'undefined';
    }

    // 安全的 gtag 呼叫
    function trackEvent(eventName, eventParams) {
      if (ensureGtag()) {
        gtag('event', eventName, eventParams);
      }
    }

    // ============================================
    // 即時執行：外部連結點擊追蹤
    // 原因：用戶可能在頁面載入後立刻點擊連結，
    //       若延遲設定 listener 會漏掉早期點擊事件。
    // ============================================
    function initExternalLinkTracking(signal) {
      var externalLinks = document.querySelectorAll('a[href^="http"]');

      externalLinks.forEach(function(link) {
        // 排除自己網站的連結
        if (!link.href.includes(window.location.hostname)) {
          link.addEventListener('click', function(e) {
            var linkUrl = link.href;
            var linkDomain = new URL(linkUrl).hostname;
            var linkText = link.textContent?.trim() || link.getAttribute('aria-label') || 'no text';

            trackEvent('outbound_click', {
              link_url: linkUrl,
              link_domain: linkDomain,
              link_text: linkText.substring(0, 100), // 限制長度
              link_location: window.location.pathname
            });
          }, { signal: signal });
        }
      });
    }

    // ============================================
    // 非關鍵初始化：放入 requestIdleCallback
    // 原因：以下為 DOM 查詢與事件綁定設定工作，
    //       不影響首次渲染，可在瀏覽器空閒時執行，
    //       改善 TBT（Total Blocking Time）約 80–150ms。
    // ============================================
    function initNonCriticalAnalytics(signal) {
      // ==========================================
      // 1. 社交分享追蹤
      // ==========================================
      var socialButtons = document.querySelectorAll('[data-social-share], .social-share-button, .share-button');

      socialButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
          var platform =
            button.dataset.platform ||
            button.getAttribute('data-social-share') ||
            button.getAttribute('aria-label') ||
            'unknown';

          trackEvent('share', {
            method: platform.toLowerCase(),
            content_type: 'article',
            item_id: window.location.pathname,
            page_title: document.title
          });
        }, { signal: signal });
      });

      // ==========================================
      // 2. 閱讀深度追蹤
      // ==========================================
      var scrollDepths = [25, 50, 75, 100];
      var trackedDepths = [];
      var maxScrollDepth = 0;

      function trackScrollDepth() {
        var windowHeight = window.innerHeight;
        var documentHeight = document.documentElement.scrollHeight;
        var scrollTop = window.scrollY || window.pageYOffset;

        var scrollPercent = Math.round(
          ((scrollTop + windowHeight) / documentHeight) * 100
        );

        // 更新最大滾動深度
        if (scrollPercent > maxScrollDepth) {
          maxScrollDepth = scrollPercent;
        }

        scrollDepths.forEach(function(depth) {
          if (scrollPercent >= depth && !trackedDepths.includes(depth)) {
            trackEvent('scroll_depth', {
              percent_scrolled: depth,
              article_title: document.title,
              page_path: window.location.pathname,
              scroll_type: 'milestone'
            });
            trackedDepths.push(depth);
          }
        });
      }

      // 使用節流避免過度觸發
      var scrollTimeout;
      window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(trackScrollDepth, 100);
      }, { signal: signal });

      // 頁面離開時追蹤最大滾動深度
      window.addEventListener('beforeunload', function() {
        if (maxScrollDepth > 0) {
          trackEvent('max_scroll_depth', {
            percent_scrolled: maxScrollDepth,
            article_title: document.title,
            page_path: window.location.pathname
          });
        }
      }, { signal: signal });

      // ==========================================
      // 3. 代碼複製追蹤
      // ==========================================
      function trackCodeCopy() {
        var copyButtons = document.querySelectorAll('.copy-button, [data-copy-code]');

        copyButtons.forEach(function(button) {
          // 避免重複綁定
          if (button.dataset.analyticsTracked) return;
          button.dataset.analyticsTracked = 'true';

          button.addEventListener('click', function() {
            var codeBlock = button.closest('pre') || button.parentElement?.querySelector('pre');
            var language =
              button.dataset.language ||
              codeBlock?.className.match(/language-(\w+)/)?.[1] ||
              'unknown';

            trackEvent('code_copy', {
              language: language,
              page_path: window.location.pathname,
              code_location: button.dataset.codeIndex || 'unknown'
            });
          }, { signal: signal });
        });
      }

      // 初始追蹤
      trackCodeCopy();

      // 使用 MutationObserver 追蹤動態加入的複製按鈕
      var codeObserver = new MutationObserver(function() {
        trackCodeCopy();
      });

      var articleContent = document.querySelector('.article-content');
      if (articleContent) {
        codeObserver.observe(articleContent, {
          childList: true,
          subtree: true
        });
      }
      _analyticsObservers.push(codeObserver);

      // ==========================================
      // 4. TOC 導航追蹤
      // ==========================================
      var tocLinks = document.querySelectorAll('.toc-item a, .mobile-toc-item a');

      tocLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          var sectionTitle = link.textContent?.trim() || 'unknown';
          var targetId = link.getAttribute('href')?.replace('#', '') || 'unknown';

          trackEvent('toc_navigation', {
            section_title: sectionTitle,
            target_id: targetId,
            toc_type: link.closest('.mobile-toc') ? 'mobile' : 'desktop',
            page_path: window.location.pathname
          });
        }, { signal: signal });
      });

      // ==========================================
      // 5. 搜尋使用追蹤
      // ==========================================
      var searchTrigger = document.getElementById('search-trigger');

      if (searchTrigger) {
        searchTrigger.addEventListener('click', function() {
          trackEvent('search_open', {
            trigger_method: 'button',
            page_path: window.location.pathname
          });
        }, { signal: signal });
      }

      // 追蹤搜尋查詢（透過 Pagefind UI）
      var searchObserver = new MutationObserver(function() {
        var searchInput = document.querySelector('.pagefind-ui__search-input');

        if (searchInput && !searchInput.dataset.analyticsTracked) {
          searchInput.dataset.analyticsTracked = 'true';

          var searchTimeout;
          searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            var query = e.target.value.trim();

            // 延遲追蹤以避免每個按鍵都觸發
            searchTimeout = setTimeout(function() {
              if (query.length >= 3) {
                trackEvent('search_query', {
                  search_term: query.substring(0, 100), // 限制長度
                  query_length: query.length,
                  page_path: window.location.pathname
                });
              }
            }, 1000);
          }, { signal: signal });
        }

        // 追蹤搜尋結果點擊
        var searchResults = document.querySelectorAll('.pagefind-ui__result');
        searchResults.forEach(function(result, index) {
          if (result.dataset.analyticsTracked) return;
          result.dataset.analyticsTracked = 'true';

          result.addEventListener('click', function() {
            var resultTitle = result.querySelector('.pagefind-ui__result-title')?.textContent?.trim() || 'unknown';

            trackEvent('search_result_click', {
              result_title: resultTitle,
              result_position: index + 1,
              page_path: window.location.pathname
            });
          }, { signal: signal });
        });
      });

      var searchModal = document.getElementById('search-modal');
      if (searchModal) {
        searchObserver.observe(searchModal, {
          childList: true,
          subtree: true
        });
      }
      _analyticsObservers.push(searchObserver);

      // ==========================================
      // 6. 麵包屑導航點擊追蹤
      // ==========================================
      var breadcrumbLinks = document.querySelectorAll('.breadcrumb-link');

      breadcrumbLinks.forEach(function(link, index) {
        link.addEventListener('click', function() {
          var breadcrumbText = link.textContent?.trim() || 'unknown';

          trackEvent('breadcrumb_click', {
            breadcrumb_text: breadcrumbText,
            breadcrumb_level: index + 1,
            target_url: link.getAttribute('href'),
            page_path: window.location.pathname
          });
        }, { signal: signal });
      });

      // ==========================================
      // 7. 系列文章導航追蹤
      // ==========================================
      var seriesNavLinks = document.querySelectorAll('.series-article-nav a');

      seriesNavLinks.forEach(function(link) {
        link.addEventListener('click', function() {
          var direction = link.textContent?.includes('上一篇') || link.textContent?.includes('Previous')
            ? 'previous'
            : 'next';

          trackEvent('series_navigation', {
            direction: direction,
            target_url: link.getAttribute('href'),
            page_path: window.location.pathname
          });
        }, { signal: signal });
      });
    }

    function initEnhancedAnalytics() {
      // 清理上一頁的所有監聽器（解決 Astro SPA 換頁累積問題）
      if (_analyticsController) {
        _analyticsController.abort();
      }
      _analyticsObservers.forEach(function(obs) { obs.disconnect(); });
      _analyticsObservers = [];

      _analyticsController = new AbortController();
      var signal = _analyticsController.signal;

      // ============================================
      // 頁面停留時間追蹤（重置至當前頁面）
      // ============================================
      var pageStartTime = Date.now();
      var pageEngaged = false;
      var engagementStartTime = null;
      var totalEngagementTime = 0;

      function startEngagement() {
        if (!pageEngaged) {
          pageEngaged = true;
          engagementStartTime = Date.now();
        }
      }

      function pauseEngagement() {
        if (pageEngaged && engagementStartTime) {
          totalEngagementTime += Date.now() - engagementStartTime;
          pageEngaged = false;
          engagementStartTime = null;
        }
      }

      var engagementEvents = ['scroll', 'click', 'keydown', 'mousemove'];
      engagementEvents.forEach(function(eventType) {
        window.addEventListener(eventType, startEngagement, { passive: true, signal: signal });
      });

      // 頁面隱藏時暫停計時
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          pauseEngagement();
        } else {
          startEngagement();
        }
      }, { signal: signal });

      // 頁面離開時追蹤總停留時間（須即時，beforeunload 容錯時間極短）
      window.addEventListener('beforeunload', function() {
        pauseEngagement();

        var totalTime = Math.round((Date.now() - pageStartTime) / 1000); // 秒
        var engagedTime = Math.round(totalEngagementTime / 1000); // 秒

        trackEvent('page_engagement', {
          engagement_time: engagedTime,
          total_time: totalTime,
          engagement_rate: totalTime > 0 ? Math.round((engagedTime / totalTime) * 100) : 0,
          page_path: window.location.pathname,
          page_title: document.title
        });
      }, { signal: signal });

      // 外部連結追蹤：立即執行，確保不漏掉早期點擊
      initExternalLinkTracking(signal);

      // 非關鍵初始化：等瀏覽器空閒再執行，改善 TBT
      _ric(function() { initNonCriticalAnalytics(signal); });
    }

    // 初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initEnhancedAnalytics);
    } else {
      initEnhancedAnalytics();
    }

    // Astro 頁面切換時重新初始化（initEnhancedAnalytics 會先清理上一頁的 listeners）
    document.addEventListener('astro:page-load', initEnhancedAnalytics);
  </script>
)}

<style>
  /* 無樣式組件 */
</style>
