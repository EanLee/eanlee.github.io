---
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import FontLoader from './FontLoader.astro';

interface Props {
	title: string;
	description?: string;
	image?: string;
	keywords?: string[];
	noindex?: boolean;
	ogType?: 'website' | 'article';
	publishedTime?: Date;
	modifiedTime?: Date;
	author?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const { 
  title, 
  description, 
  image = '/blog-placeholder-1.jpg',
  keywords = [],
  noindex = false,
  ogType = 'website',
  publishedTime,
  modifiedTime,
  author = 'Ean Lee'
} = Astro.props;
---

<!-- Theme initialization script - 固定深色主題 -->
<script is:inline>
  (function() {
    // 固定設定為深色主題
    document.documentElement.dataset.theme = 'dark';
    
    // 首次載入時添加 no-transition class 防止閃爍動畫
    document.documentElement.classList.add('no-transition');
    
    // 頁面載入後移除 no-transition
    window.addEventListener('load', function() {
      setTimeout(function() {
        document.documentElement.classList.remove('no-transition');
      }, 0);
    });
  })();
</script>

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.ico" />
<meta name="generator" content={Astro.generator} />


<!-- SEO & Security -->
{noindex && <meta name="robots" content="noindex, nofollow" />}
<meta name="referrer" content="strict-origin-when-cross-origin" />

<!-- DNS Prefetch for better performance -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">

<ViewTransitions />

<!-- Preconnect to external domains -->
<link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
<link rel="preconnect" href="https://tpc.googlesyndication.com" crossorigin>
<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin>

<!-- Preload critical resources -->
<link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin />

<!-- Critical CSS for font loading -->
<style>
  html.font-loading {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
</style>

<!-- Google AdSense - 延遲載入以提升效能 -->
<script type="module">
  // 延遲載入 AdSense，避免阻塞初始渲染
  function loadAdSense() {
    if (window.adsbygoogle_loaded) return; // 避免重複載入
    window.adsbygoogle_loaded = true;
    
    const script = document.createElement('script');
    script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7903108559996033';
    script.async = true;
    script.crossOrigin = 'anonymous';
    script.onload = () => {
      // 初始化已存在的廣告
      document.querySelectorAll('.adsbygoogle').forEach(ad => {
        if (!ad.dataset.adsbygoogleStatus) {
          try {
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            console.warn('AdSense initialization failed:', e);
          }
        }
      });
    };
    script.onerror = () => console.warn('AdSense failed to load');
    document.head.appendChild(script);
  }

  // 用戶互動後再載入 AdSense，符合 Core Web Vitals 最佳實踐
  function initAdSense() {
    loadAdSense();
    // 移除事件監聽器
    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
      document.removeEventListener(event, initAdSense, { passive: true });
    });
  }

  // 監聽用戶互動
  ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, initAdSense, { passive: true });
  });

  // 備用：5秒後自動載入 (確保即使沒互動也能顯示廣告)
  setTimeout(loadAdSense, 5000);
</script>

<!-- Google Analytics - 優化載入 -->
<script type="module">
  function loadGoogleAnalytics() {
    // 載入 gtag.js
    const script = document.createElement('script');
    script.src = 'https://www.googletagmanager.com/gtag/js?id=G-4HXSCXTZKZ';
    script.async = true;
    script.onload = () => {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4HXSCXTZKZ', {
        send_page_view: false // 防止重複發送頁面瀏覽
      });
      
      // 手動發送頁面瀏覽事件
      gtag('config', 'G-4HXSCXTZKZ', {
        page_title: document.title,
        page_location: window.location.href
      });
    };
    document.head.appendChild(script);
  }

  // 用戶互動後再載入 GA，符合 Core Web Vitals 最佳實踐
  function initGA() {
    loadGoogleAnalytics();
    // 移除事件監聽器
    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
      document.removeEventListener(event, initGA, { passive: true });
    });
  }

  // 監聽用戶互動
  ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, initGA, { passive: true });
  });
  
  // 備用：3秒後自動載入
  setTimeout(loadGoogleAnalytics, 3000);
</script>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
{keywords.length > 0 && <meta name="keywords" content={keywords.join(', ')} />}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={ogType} />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:locale" content="zh_TW" />
{ogType === 'article' && publishedTime && (
  <>
    <meta property="article:published_time" content={publishedTime.toISOString()} />
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime.toISOString()} />}
    <meta property="article:author" content={author} />
  </>
)}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />
<meta property="twitter:image:width" content="1200" />
<meta property="twitter:image:height" content="630" />

<!-- Font Loading Optimization -->
<FontLoader />
