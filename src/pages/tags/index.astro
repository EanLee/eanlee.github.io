---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { SITE_TITLE } from "../../consts";

const posts = await getCollection("blog");

// 統計每個標籤的文章數（保留原始大小寫用於顯示）
const tagMap = new Map<string, { display: string; count: number }>();
for (const post of posts) {
  for (const tag of post.data.tags ?? []) {
    const key = tag.toLowerCase();
    if (!tagMap.has(key)) {
      tagMap.set(key, { display: tag, count: 0 });
    }
    tagMap.get(key)!.count++;
  }
}

// 按文章數降序排列
const tags = [...tagMap.entries()]
  .sort((a, b) => b[1].count - a[1].count)
  .map(([key, val]) => ({ key, ...val }));

const maxCount = tags[0]?.count ?? 1;

const collectionPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `標籤 - ${SITE_TITLE}`,
  description: `以標籤瀏覽所有文章，共 ${tags.length} 個標籤`,
  url: new URL("/tags/", Astro.site).href,
  numberOfItems: tags.length,
  itemListElement: tags.map((tag, i) => ({
    "@type": "ListItem",
    position: i + 1,
    url: new URL(`/tags/${tag.key}/`, Astro.site).href,
    name: tag.display,
  })),
};
---

<!doctype html>
<html lang="zh-TW">
  <head>
    <BaseHead
      title={`標籤 - ${SITE_TITLE}`}
      description={`以標籤瀏覽所有文章，共 ${tags.length} 個標籤`}
    />
    <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  </head>
  <body>
    <Header />
    <main class="tags-index">
      <div class="container">

        <div class="page-header">
          <div class="header-text">
            <h1>
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/>
                <circle cx="7.5" cy="7.5" r="1.5"/>
              </svg>
              標籤
            </h1>
            <p class="subtitle">從主題關鍵字橫切瀏覽文章，找到你感興趣的技術領域</p>
          </div>
          <div class="header-stat">
            <span class="stat-number">{tags.length}</span>
            <span class="stat-label">個標籤</span>
          </div>
        </div>

        <div class="tags-cloud">
          {tags.map((tag) => {
            // 依文章數計算字體大小：最多的標籤最大，其餘按比例縮放
            const ratio = tag.count / maxCount;
            const size = ratio > 0.5 ? "lg" : ratio > 0.2 ? "md" : "sm";
            return (
              <a href={`/tags/${tag.key}/`} class={`tag-chip size-${size}`}>
                {tag.display}
                <span class="tag-count">{tag.count}</span>
              </a>
            );
          })}
        </div>

        <p class="hint">
          也可以用 <a href="/series/">系列文章</a> 或 <a href="/archives/">文章列表</a> 瀏覽
        </p>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .tags-index {
    flex: 1;
  }

  .container {
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-md);
  }

  /* 頁面標題區 */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--color-border-light);
  }

  h1 {
    font-size: 1.75rem;
    font-weight: var(--font-weight-bold);
    margin: 0 0 var(--spacing-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  h1 svg {
    color: var(--color-primary);
  }

  .subtitle {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: 0;
  }

  .header-stat {
    text-align: right;
    flex-shrink: 0;
  }

  .stat-number {
    display: block;
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    line-height: 1;
  }

  .stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* 標籤雲 */
  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-xl);
  }

  .tag-chip {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-md);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-full);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg-secondary);
    transition:
      border-color var(--transition-normal),
      background var(--transition-normal),
      transform var(--transition-normal);
  }

  .tag-chip:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    background: var(--color-bg-muted);
    transform: translateY(-1px);
  }

  /* 依文章數量的字體大小層級 */
  .tag-chip.size-lg {
    font-size: var(--font-size-lg);
    padding: var(--spacing-sm) var(--spacing-lg);
    font-weight: var(--font-weight-semibold);
    border-width: 2px;
  }

  .tag-chip.size-md {
    font-size: var(--font-size-base);
  }

  .tag-chip.size-sm {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  .tag-chip.size-sm:hover {
    color: var(--color-primary);
  }

  .tag-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    background: var(--color-bg-muted);
    border-radius: var(--radius-full);
    padding: 0 var(--spacing-xs);
    min-width: 1.25rem;
    text-align: center;
    transition: background var(--transition-normal);
  }

  .tag-chip:hover .tag-count {
    background: var(--color-bg-primary);
    color: var(--color-text-muted);
  }

  /* 底部提示 */
  .hint {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    text-align: right;
    margin: 0;
  }

  .hint a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .hint a:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-md);
    }

    .header-stat {
      text-align: left;
      display: flex;
      align-items: baseline;
      gap: var(--spacing-xs);
    }

    h1 {
      font-size: 1.5rem;
    }
  }
</style>
