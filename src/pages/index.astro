---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";
import Sidebar from "../components/sidebar.astro";
import EpicBlock from "../components/EpicBlock.astro";

// 獲取所有文章
const allPosts = await getCollection("blog");

// 按日期排序
const sortedPosts = allPosts.sort((a, b) =>
    b.data.date.valueOf() - a.data.date.valueOf()
);

// 獲取軟體開發類別的文章
const softwarePosts = sortedPosts
    .filter(post => {
        if ('epic' in post.data) {
            return post.data.epic === "software";
        }
        return true;
    })
    .slice(0, 5);

// 獲取管理經驗類別的文章
const managementPosts = sortedPosts
    .filter(post => {
        if ('epic' in post.data) {
            return post.data.epic === "management";
        }
        return false;
    })
    .slice(0, 5);

// 獲取閱讀心得類別的文章
const readingPosts = sortedPosts
    .filter(post => {
        if ('epic' in post.data) {
            return post.data.epic === "reading";
        }
        return false;
    })
    .slice(0, 5);

// 獲取個人成長類別的文章
const growthPosts = sortedPosts
    .filter(post => {
        if ('epic' in post.data) {
            return post.data.epic === "growth";
        }
        return false;
    })
    .slice(0, 5);


// 為SEO準備關鍵字
const keywords = [
  "技術部落格", "軟體開發", "管理經驗", "閱讀心得", "個人成長", 
  "程式設計", "技術分享", ".NET開發", "Cloud Native", "系統架構",
  "容器化", "DevOps", "軟體工程", "技術管理", "後端開發"
];

// 增強的 SEO description
const enhancedDescription = `${SITE_DESCRIPTION} 涵蓋軟體開發、技術管理、系統架構設計等豐富內容，助您在技術職涯中持續成長。`;

// BreadcrumbList 結構化資料
const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "首頁",
      "item": Astro.url.toString()
    }
  ]
};

// 網站導航結構化資料
const siteNavigationData = {
  "@context": "https://schema.org",
  "@type": "SiteNavigationElement",
  "name": "主要導航",
  "url": [
    new URL("/software/", Astro.url).toString(),
    new URL("/management/", Astro.url).toString(),
    new URL("/reading/", Astro.url).toString(),
    new URL("/growth/", Astro.url).toString(),
    new URL("/archives/", Astro.url).toString()
  ]
};

// 增強的部落格結構化資料
const blogStructuredData = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "headline": SITE_TITLE,
  "description": enhancedDescription,
  "url": Astro.url.toString(),
  "inLanguage": "zh-TW",
  "author": {
    "@type": "Person",
    "name": "Ean Lee",
    "description": "資深軟體開發者，專注於 .NET、Cloud Native 與系統架構設計",
    "url": Astro.url.toString(),
    "sameAs": [
      "https://github.com/EanLee"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "伊恩的開發狂想",
    "description": "技術部落格，分享軟體開發與技術管理經驗",
    "url": Astro.url.toString(),
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/favicon.ico", Astro.url).toString(),
      "width": 60,
      "height": 60
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.toString()
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": new URL("/search/?q={search_term_string}", Astro.url).toString()
    },
    "query-input": "required name=search_term_string"
  }
};
---

<!doctype html>
<html lang="zh-TW" itemscope itemtype="https://schema.org/Blog">
<head>
    <BaseHead 
      title={SITE_TITLE} 
      description={enhancedDescription} 
      keywords={keywords}
    />
    <style>
        .home-container {
            width: 100%;
            max-width: var(--container-xl);
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px minmax(0, 1fr);
            gap: var(--spacing-xl);
            margin: var(--spacing-lg) 0 var(--spacing-2xl);
        }

        .sidebar-area {
            width: 300px;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 250px minmax(0, 1fr);
            }

            .sidebar-area {
                width: 250px;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar-area {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .home-container {
                padding: 0 var(--spacing-sm);
            }
        }
    </style>

    <!-- Structured Data for SEO -->
    <script type="application/ld+json" set:html={JSON.stringify(blogStructuredData)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
    <script type="application/ld+json" set:html={JSON.stringify(siteNavigationData)} />
</head>
<body>
<Header />

<div class="home-container">
    <div class="main-content">
        <div class="sidebar-area">
            <Sidebar />
        </div>
        
        <div class="content-area">
            <div class="epic-blocks">
                <EpicBlock 
                    title="軟體開發" 
                    posts={softwarePosts} 
                    viewAllLink="/software/" 
                />
                <EpicBlock 
                    title="管理經驗" 
                    posts={managementPosts} 
                    viewAllLink="/management/" 
                />
                <EpicBlock 
                    title="閱讀心得" 
                    posts={readingPosts} 
                    viewAllLink="/reading/" 
                />
                <EpicBlock 
                    title="自我成長" 
                    posts={growthPosts} 
                    viewAllLink="/growth/" 
                />
            </div>
        </div>
    </div>
</div>

<Footer />
</body>
</html>
