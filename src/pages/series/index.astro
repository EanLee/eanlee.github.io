---
import { getCollection } from "astro:content";
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { SITE_TITLE, EPIC_LABELS } from "../../consts";
import { getSeriesData, groupSeriesByEpic } from "../../utils/series";

const allPosts = await getCollection("blog");
const seriesList = getSeriesData(allPosts);
const groupedSeries = groupSeriesByEpic(seriesList);

const formatDate = (date: Date) =>
  date.toLocaleDateString("zh-TW", { year: "numeric", month: "2-digit" });

// CollectionPage + ItemList Schema（與 /categories/ 頁面格式一致）
const collectionPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `系列文章 - ${SITE_TITLE}`,
  description: "按主題組織的完整學習路徑",
  url: new URL("/series/", Astro.site).href,
  numberOfItems: seriesList.length,
  itemListElement: seriesList.map((s, i) => ({
    "@type": "ListItem",
    position: i + 1,
    url: new URL(`/series/${s.seriesPath}/`, Astro.site).href,
    name: s.seriesTitle,
  })),
};
---

<!doctype html>
<html lang="zh-TW">
  <head>
    <BaseHead
      title={`系列文章 - ${SITE_TITLE}`}
      description="按主題組織的完整學習路徑，從 CI/CD、Docker 到系統架構設計"
    />
    <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  </head>
  <body>
    <Header />
    <main class="series-index">
      <div class="container">
        <h1>系列文章</h1>
        <p class="subtitle">按主題組織的完整學習路徑</p>

        {groupedSeries.map(([epic, series]) => (
          <section class="epic-group">
            <h2 class="epic-title">{EPIC_LABELS[epic] ?? epic}</h2>
            <div class="series-grid">
              {series.map((s) => (
                <a href={`/series/${s.seriesPath}/`} class="series-card">
                  <h3 class="card-title">{s.seriesTitle}</h3>
                  <div class="card-meta">
                    <span>{s.count} 篇</span>
                    <span>更新於 {formatDate(s.latestDate)}</span>
                  </div>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .series-index {
    flex: 1;
  }

  .container {
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-md);
  }

  h1 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--spacing-xs);
  }

  .subtitle {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-2xl);
  }

  .epic-group {
    margin-bottom: var(--spacing-2xl);
  }

  .epic-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-muted);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }

  .series-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
  }

  .series-card {
    display: block;
    padding: var(--spacing-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg-secondary);
    transition:
      box-shadow var(--transition-normal),
      transform var(--transition-normal);
  }

  .series-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .card-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--spacing-sm);
    color: var(--color-text);
  }

  .card-meta {
    display: flex;
    gap: var(--spacing-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .series-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .series-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
